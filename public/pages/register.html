<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no"/>
  <title>Voter Registration â€” VoteSecure</title>
  <link rel="stylesheet" href="/css/style.css"/>
  <style>
    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
    body{background:#0f172a;min-height:100vh;}
    .page{max-width:520px;margin:0 auto;padding:14px 14px 60px;}

    /* Steps */
    .steps{display:flex;background:rgba(255,255,255,.07);border-radius:12px;padding:4px;margin-bottom:14px;}
    .sp{flex:1;padding:8px 2px;text-align:center;border-radius:9px;font-size:10px;font-weight:700;color:rgba(255,255,255,.3);transition:all .25s;white-space:nowrap;}
    .sp.active{background:white;color:#4f46e5;}
    .sp.done{color:rgba(255,255,255,.55);}

    /* Card */
    .card{background:white;border-radius:20px;padding:22px;margin-bottom:12px;}
    .ctitle{font-size:1.1rem;font-weight:800;margin:0 0 3px;}
    .csub{color:#64748b;font-size:13px;margin:0 0 18px;}

    /* Form */
    .lbl{font-size:11px;font-weight:800;text-transform:uppercase;letter-spacing:.06em;color:#64748b;display:block;margin-bottom:5px;}
    .inp{width:100%;padding:12px 14px;border:2px solid #e2e8f0;border-radius:10px;font-size:15px;outline:none;transition:border-color .2s;background:white;}
    .inp:focus{border-color:#4f46e5;box-shadow:0 0 0 3px rgba(79,70,229,.1);}
    .fg{margin-bottom:14px;}

    /* Buttons */
    .btn{width:100%;height:52px;border-radius:14px;border:none;font-size:15px;font-weight:700;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;touch-action:manipulation;text-decoration:none;transition:all .15s;}
    .btn.blue {background:#4f46e5;color:white;}
    .btn.blue:hover:not(:disabled){background:#3730a3;}
    .btn.blue:disabled{background:#a5b4fc;cursor:not-allowed;}
    .btn.green{background:#059669;color:white;}
    .btn.grey {background:#f1f5f9;color:#0f172a;font-size:14px;}
    .btn-row  {display:flex;gap:10px;margin-top:8px;}

    /* Alerts */
    .al{padding:11px 14px;border-radius:10px;font-size:13px;font-weight:600;margin-bottom:10px;}
    .al.err {background:#fee2e2;color:#b91c1c;border:1px solid #fecaca;}
    .al.ok  {background:#dcfce7;color:#15803d;border:1px solid #bbf7d0;}
    .al.warn{background:#fef3c7;color:#a16207;border:1px solid #fde68a;}
    .al.info{background:#e0e7ff;color:#4338ca;border:1px solid #c7d2fe;}

    /* OTP boxes */
    .otp-row{display:flex;gap:8px;justify-content:center;margin:14px 0;}
    .otp-d{width:46px;height:54px;border:2px solid #e2e8f0;border-radius:10px;font-size:1.4rem;font-weight:900;text-align:center;outline:none;transition:all .2s;}
    .otp-d:focus{border-color:#4f46e5;box-shadow:0 0 0 3px rgba(79,70,229,.12);}
    .otp-d.ok{border-color:#10b981;background:#f0fdf4;}

    /* Proof type cards */
    .proof-row{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:14px;}
    .pcard{border:2px solid #e2e8f0;border-radius:14px;padding:16px 10px;text-align:center;cursor:pointer;transition:all .2s;user-select:none;}
    .pcard:hover{border-color:#a5b4fc;background:#f5f3ff;}
    .pcard.sel{border-color:#4f46e5;background:#eef2ff;box-shadow:0 0 0 3px rgba(79,70,229,.1);}
    .pcard .icon{font-size:2.2rem;margin-bottom:8px;}
    .pcard .pname{font-weight:800;font-size:13px;}
    .pcard .pdesc{font-size:11px;color:#64748b;margin-top:3px;}

    /* Document camera */
    .doc-cam{position:relative;background:#000;border-radius:16px;overflow:hidden;width:100%;aspect-ratio:16/10;margin-bottom:8px;}
    .doc-cam video{width:100%;height:100%;object-fit:cover;display:block;}
    .doc-frame{position:absolute;top:8%;left:5%;right:5%;bottom:8%;border:3px dashed rgba(255,255,255,.7);border-radius:10px;pointer-events:none;transition:all .3s;}
    .doc-frame.scan{border-color:#f59e0b;border-style:solid;animation:blink .8s infinite;}
    .doc-frame.good{border-color:#10b981;border-style:solid;}
    .doc-corner{position:absolute;width:20px;height:20px;border-color:#10b981;border-style:solid;}
    .doc-corner.tl{top:8%;left:5%;border-width:3px 0 0 3px;border-radius:4px 0 0 0;}
    .doc-corner.tr{top:8%;right:5%;border-width:3px 3px 0 0;border-radius:0 4px 0 0;}
    .doc-corner.bl{bottom:8%;left:5%;border-width:0 0 3px 3px;border-radius:0 0 0 4px;}
    .doc-corner.br{bottom:8%;right:5%;border-width:0 3px 3px 0;border-radius:0 0 4px 0;}
    @keyframes blink{0%,100%{opacity:1;}50%{opacity:.3;}}
    .cam-bar{position:absolute;bottom:0;left:0;right:0;background:rgba(0,0,0,.82);color:white;padding:8px 12px;text-align:center;font-size:12px;font-weight:600;}
    .cam-top{position:absolute;top:0;left:0;right:0;padding:8px 12px;display:flex;justify-content:space-between;align-items:center;background:linear-gradient(to bottom,rgba(0,0,0,.72),transparent);}
    .lx{padding:3px 9px;border-radius:99px;font-size:10px;font-weight:700;color:white;background:rgba(0,0,0,.5);}
    .icn{width:32px;height:32px;background:rgba(255,255,255,.15);border:none;border-radius:50%;color:white;font-size:14px;cursor:pointer;display:flex;align-items:center;justify-content:center;}
    .icn.on{background:rgba(79,70,229,.75);}

    /* Face camera */
    .face-cam{position:relative;background:#000;border-radius:18px;overflow:hidden;width:100%;aspect-ratio:3/4;max-height:360px;}
    .face-cam video{width:100%;height:100%;object-fit:cover;display:block;}
    .oval-wrap{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;pointer-events:none;}
    .oval{width:54%;height:74%;border-radius:50%;border:3px solid rgba(255,255,255,.5);box-shadow:0 0 0 9999px rgba(0,0,0,.46);transition:all .25s;}
    .oval.rdy{border-color:#10b981;box-shadow:0 0 0 9999px rgba(0,0,0,.4),0 0 20px rgba(16,185,129,.5);}
    .oval.bad{border-color:#ef4444;}
    .face-btm{position:absolute;bottom:0;left:0;right:0;padding:11px;background:linear-gradient(to top,rgba(0,0,0,.8),transparent);}
    .face-txt{color:white;font-size:12px;font-weight:600;text-align:center;margin-bottom:7px;}
    .dots{display:flex;gap:8px;justify-content:center;}
    .dot{width:11px;height:11px;border-radius:50%;background:rgba(255,255,255,.3);transition:all .3s;}
    .dot.f{background:#10b981;transform:scale(1.2);}
    .dot.a{background:#f59e0b;animation:pd .6s infinite;}
    @keyframes pd{0%,100%{transform:scale(1);}50%{transform:scale(1.3);}}

    /* Progress */
    .prog{background:#f1f5f9;border-radius:99px;height:5px;overflow:hidden;max-width:260px;margin:8px auto 0;}
    .prog-f{height:100%;background:#4f46e5;border-radius:99px;transition:width .4s;}

    /* Spinners */
    @keyframes spin{to{transform:rotate(360deg);}}
    .spin  {width:17px;height:17px;border:2px solid rgba(255,255,255,.3);border-top-color:white;border-radius:50%;animation:spin .6s linear infinite;flex-shrink:0;}
    .spin-b{width:15px;height:15px;border:2px solid rgba(79,70,229,.2);border-top-color:#4f46e5;border-radius:50%;animation:spin .6s linear infinite;}

    /* Voter ID card */
    .vid-card{background:linear-gradient(135deg,#1e1b4b,#4338ca);border-radius:18px;padding:26px;color:white;text-align:center;max-width:300px;margin:0 auto 16px;}
    .vid-num {font-size:1.8rem;font-weight:900;letter-spacing:.13em;font-family:monospace;margin:8px 0;}

    /* Preview */
    .prev{position:relative;border-radius:14px;overflow:hidden;margin-bottom:10px;}
    .prev canvas{width:100%;display:block;}
    .prev-badge{position:absolute;top:10px;right:10px;background:rgba(16,185,129,.9);color:white;border-radius:8px;padding:4px 10px;font-size:11px;font-weight:700;}

    /* OCR */
    .ocr-box{border-radius:12px;padding:14px;margin:10px 0;}
    .ocr-box.ok  {background:#dcfce7;border:2px solid #10b981;}
    .ocr-box.fail{background:#fee2e2;border:2px solid #ef4444;}
    .ocr-box.warn{background:#fef3c7;border:2px solid #f59e0b;}
    .ocr-row{display:flex;align-items:center;gap:8px;margin-bottom:7px;}
    .ocr-row:last-child{margin:0;}
    .ocr-k{font-size:11px;font-weight:800;text-transform:uppercase;color:#64748b;min-width:55px;flex-shrink:0;}
    .ocr-v{font-size:14px;font-weight:800;color:#0f172a;flex:1;word-break:break-all;}
    .tag  {font-size:10px;font-weight:700;padding:2px 8px;border-radius:99px;white-space:nowrap;}
    .tag.ok  {background:#dcfce7;color:#15803d;}
    .tag.fail{background:#fee2e2;color:#b91c1c;}
    .tag.warn{background:#fef3c7;color:#92400e;}

    /* Confidence meter */
    .conf-bar{height:4px;background:#e2e8f0;border-radius:99px;margin-top:10px;overflow:hidden;}
    .conf-fill{height:100%;border-radius:99px;transition:width .5s;}

    @media(max-width:400px){.proof-row{grid-template-columns:1fr;}.otp-d{width:38px;height:48px;font-size:1.2rem;}}
  </style>
</head>
<body>
<nav style="background:rgba(255,255,255,.05);backdrop-filter:blur(12px);border-bottom:1px solid rgba(255,255,255,.1);padding:0 18px;height:56px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:100;">
  <a href="/" style="color:white;font-weight:800;font-size:1.05rem;text-decoration:none;">ğŸ—³ï¸ VoteSecure</a>
  <a href="/voter-login" style="color:rgba(255,255,255,.6);font-size:12px;text-decoration:none;">Already registered? â†’</a>
</nav>

<div class="page">
  <div class="steps" style="margin-top:14px;">
    <div class="sp" id="sp1">1Â·Info</div>
    <div class="sp" id="sp2">2Â·OTP</div>
    <div class="sp" id="sp3">3Â·ID Proof</div>
    <div class="sp" id="sp4">4Â·Face</div>
    <div class="sp" id="sp5">5Â·Done</div>
  </div>

  <!-- â”€â”€â”€ STEP 1: Info â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div id="step1" style="display:none;">
    <div class="card">
      <p class="ctitle">ğŸ“‹ Personal Information</p>
      <p class="csub">Enter details exactly as on your ID document</p>
      <div id="e1"></div>
      <div class="fg">
        <label class="lbl">Full Name *</label>
        <input id="fName" class="inp" type="text" placeholder="As on Aadhaar / PAN Card" autocomplete="name"/>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
        <div class="fg">
          <label class="lbl">Date of Birth *</label>
          <input id="fDob" class="inp" type="date"/>
        </div>
        <div class="fg">
          <label class="lbl">Phone Number *</label>
          <input id="fPhone" class="inp" type="tel" placeholder="10-digit mobile" inputmode="tel" autocomplete="tel"/>
        </div>
      </div>
      <div class="fg" style="margin-bottom:18px;">
        <label class="lbl">Address</label>
        <textarea id="fAddr" class="inp" rows="2" placeholder="Residential address" style="resize:none;"></textarea>
      </div>
      <button class="btn blue" onclick="s1Next()">Continue â†’ OTP Verification</button>
    </div>
  </div>

  <!-- â”€â”€â”€ STEP 2: OTP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div id="step2" style="display:none;">
    <div class="card">
      <p class="ctitle">ğŸ“± Phone Verification</p>
      <p class="csub">Verify your mobile number with a 6-digit OTP</p>
      <div id="e2"></div>
      <div class="al info" style="font-size:12px;margin-bottom:12px;">â„¹ï¸ <strong>Demo Mode:</strong> OTP shown on screen. In production it is sent via SMS.</div>

      <div id="otpSend">
        <div style="background:#f8fafc;border-radius:12px;padding:14px;margin-bottom:14px;display:flex;align-items:center;gap:12px;">
          <span style="font-size:1.8rem;">ğŸ“±</span>
          <div>
            <div style="font-size:11px;color:#64748b;font-weight:700;text-transform:uppercase;">Sending OTP to</div>
            <div id="phoneDisp" style="font-weight:800;font-size:1rem;font-family:monospace;color:#0f172a;"></div>
          </div>
        </div>
        <button class="btn blue" id="btnSend" onclick="sendOtp()">ğŸ“¤ Send OTP</button>
      </div>

      <div id="otpEntry" style="display:none;">
        <p style="text-align:center;font-size:13px;color:#64748b;margin-bottom:2px;">Enter the 6-digit OTP</p>
        <div id="otpHint" style="display:none;text-align:center;background:#fef3c7;border-radius:8px;padding:7px 14px;font-size:14px;font-weight:800;color:#92400e;margin-bottom:4px;"></div>
        <div class="otp-row" id="otpRow"></div>
        <p id="otpTimer" style="text-align:center;font-size:12px;color:#64748b;margin-bottom:12px;"></p>
        <button class="btn blue" id="btnVerify" onclick="verifyOtp()" disabled>âœ… Verify OTP</button>
        <button class="btn grey" onclick="resetOtp()" style="margin-top:8px;">ğŸ”„ Resend OTP</button>
      </div>

      <button class="btn grey" onclick="goStep(1)" style="margin-top:8px;">â† Back</button>
    </div>
  </div>

  <!-- â”€â”€â”€ STEP 3: ID Proof â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div id="step3" style="display:none;">

    <!-- 3a: Choose document type -->
    <div id="s3a" class="card">
      <p class="ctitle">ğŸªª Choose ID Document</p>
      <p class="csub">Select the ID you want to verify with â€” scan or upload a photo</p>
      <div id="e3a"></div>

      <!-- Aadhaar Card -->
      <div class="pcard" id="pc-aadhaar" onclick="pickProof('aadhaar')" style="display:flex;align-items:center;gap:14px;padding:16px;text-align:left;margin-bottom:10px;">
        <div style="width:48px;height:48px;border-radius:14px;background:#eef2ff;display:flex;align-items:center;justify-content:center;font-size:1.8rem;flex-shrink:0;">ğŸªª</div>
        <div style="flex:1;">
          <div style="font-weight:800;font-size:14px;color:#0f172a;">Aadhaar Card</div>
          <div style="font-size:12px;color:#64748b;margin-top:3px;">Government issued Â· Verifies Name &amp; Date of Birth</div>
        </div>
        <div id="pc-aadhaar-tick" style="font-size:1.4rem;flex-shrink:0;">â¬œ</div>
      </div>

      <!-- PAN Card -->
      <div class="pcard" id="pc-pan" onclick="pickProof('pan')" style="display:flex;align-items:center;gap:14px;padding:16px;text-align:left;margin-bottom:10px;">
        <div style="width:48px;height:48px;border-radius:14px;background:#f0fdf4;display:flex;align-items:center;justify-content:center;font-size:1.8rem;flex-shrink:0;">ğŸ’³</div>
        <div style="flex:1;">
          <div style="font-weight:800;font-size:14px;color:#0f172a;">PAN Card</div>
          <div style="font-size:12px;color:#64748b;margin-top:3px;">Income Tax Dept Â· Verifies Name &amp; Date of Birth</div>
        </div>
        <div id="pc-pan-tick" style="font-size:1.4rem;flex-shrink:0;">â¬œ</div>
      </div>

      <!-- College ID -->
      <div class="pcard" id="pc-college" onclick="pickProof('college')" style="display:flex;align-items:center;gap:14px;padding:16px;text-align:left;margin-bottom:18px;">
        <div style="width:48px;height:48px;border-radius:14px;background:#fef9c3;display:flex;align-items:center;justify-content:center;font-size:1.8rem;flex-shrink:0;">ğŸ“</div>
        <div style="flex:1;">
          <div style="font-weight:800;font-size:14px;color:#0f172a;">College ID Card</div>
          <div style="font-size:12px;color:#64748b;margin-top:3px;">Student identity Â· Verifies Name (DOB optional)</div>
        </div>
        <div id="pc-college-tick" style="font-size:1.4rem;flex-shrink:0;">â¬œ</div>
      </div>

      <div id="proofTip" style="display:none;margin-bottom:14px;"></div>
      <button class="btn blue" id="btnGoScan" onclick="startScan()" disabled>Continue â†’ Scan / Upload Document</button>
      <button class="btn grey" onclick="goStep(2)" style="margin-top:8px;">â† Back</button>
    </div>

    <!-- 3b: Camera + Upload -->
    <div id="s3b" style="display:none;">
      <div class="card">
        <p class="ctitle" id="scanTitle">ğŸ“· Scan Document</p>
        <p class="csub" id="scanSub">Choose how to submit your ID</p>
        <div id="e3b"></div>

        <!-- Method tabs -->
        <div style="display:flex;gap:8px;margin-bottom:14px;">
          <button id="tabCam" onclick="switchTab('cam')"
            style="flex:1;height:44px;border-radius:10px;border:2px solid #4f46e5;background:#eef2ff;color:#4f46e5;font-weight:700;font-size:13px;cursor:pointer;">
            ğŸ“· Camera
          </button>
          <button id="tabUpload" onclick="switchTab('upload')"
            style="flex:1;height:44px;border-radius:10px;border:2px solid #e2e8f0;background:#f8fafc;color:#64748b;font-weight:700;font-size:13px;cursor:pointer;">
            ğŸ“ Upload Photo
          </button>
        </div>

        <!-- â•â•â• CAMERA TAB â•â•â• -->
        <div id="tabCamContent">
          <div id="deviceTip" style="display:none;margin-bottom:12px;"></div>

          <!-- Camera dropdown - always shown on desktop -->
          <div id="camSelectWrap" style="display:none;margin-bottom:10px;">
            <label class="lbl">Select Camera</label>
            <select id="camSelect" class="inp" style="height:44px;padding:8px 12px;" onchange="switchCamera()"></select>
            <p style="font-size:11px;color:#94a3b8;margin:4px 0 0 4px;">â¬†ï¸ Camera black? Choose a different one above</p>
          </div>

          <div id="docLoading" style="text-align:center;padding:20px 0;">
            <div class="spin-b" style="margin:0 auto 10px;"></div>
            <p id="docLoadTxt" style="font-size:13px;color:#64748b;font-weight:600;">Starting cameraâ€¦</p>
          </div>

          <div id="docCamWrap" style="display:none;">
            <div class="doc-cam" id="docCamBox">
              <video id="docVid" autoplay muted playsinline></video>
              <div class="cam-top">
                <span class="lx" id="docLx">ğŸ’¡â€”</span>
                <div style="display:flex;gap:7px;">
                  <button class="icn" id="btnFlipDoc" onclick="flipDocCam()" style="display:none;" title="Flip camera">ğŸ”„</button>
                  <button class="icn" id="docBoost" onclick="toggleDocBoost()" title="Boost brightness">â˜€ï¸</button>
                </div>
              </div>
              <div class="doc-frame" id="docFrame"></div>
              <div class="doc-corner tl"></div><div class="doc-corner tr"></div>
              <div class="doc-corner bl"></div><div class="doc-corner br"></div>
              <div class="cam-bar" id="docBar">ğŸ“„ Hold document inside the frame</div>
            </div>
            <p id="docHint" style="text-align:center;font-size:11px;color:rgba(255,255,255,.4);margin:6px 0 10px;"></p>
            <div id="docTipBox" style="margin-bottom:10px;"></div>
            <div class="btn-row">
              <button class="btn grey" style="max-width:70px;" onclick="stopDocCam();showS3a()">â† Back</button>
              <button class="btn blue" id="btnCap" onclick="captureDoc()">ğŸ“¸ Capture</button>
            </div>
          </div>
        </div>

        <!-- â•â•â• UPLOAD TAB â•â•â• -->
        <div id="tabUploadContent" style="display:none;">
          <div class="al info" style="font-size:12px;margin-bottom:14px;">
            ğŸ’¡ <strong>Best for Laptop/PC:</strong> Take a clear photo of your ID with your phone â†’ send via WhatsApp/email/USB â†’ upload here. Or drag &amp; drop a JPG/PNG.
          </div>

          <!-- Drop zone -->
          <div id="uploadZone"
            onclick="document.getElementById('fileInput').click()"
            ondragover="event.preventDefault();this.style.borderColor='#4f46e5';this.style.background='#eef2ff';"
            ondragleave="this.style.borderColor='#cbd5e1';this.style.background='#f8fafc';"
            ondrop="handleDrop(event)"
            style="border:2px dashed #cbd5e1;border-radius:14px;padding:32px 20px;text-align:center;cursor:pointer;background:#f8fafc;transition:all .2s;margin-bottom:12px;">
            <div style="font-size:2.8rem;margin-bottom:8px;">ğŸ“</div>
            <div style="font-weight:700;font-size:15px;color:#0f172a;margin-bottom:4px;">Click to upload or drag &amp; drop</div>
            <div style="font-size:12px;color:#64748b;">JPG Â· PNG Â· JPEG â€” Max 10MB</div>
          </div>
          <input type="file" id="fileInput" accept="image/jpeg,image/jpg,image/png" style="display:none;" onchange="handleFileUpload(event)"/>

          <!-- Preview after upload -->
          <div id="uploadPreview" style="display:none;margin-bottom:12px;">
            <img id="uploadImg" style="width:100%;border-radius:12px;display:block;margin-bottom:8px;border:2px solid #e2e8f0;" alt="ID preview"/>
            <div class="al ok" style="font-size:12px;margin-bottom:8px;">âœ… Image loaded â€” click Verify Document below</div>
            <div class="btn-row">
              <button class="btn grey" style="max-width:110px;" onclick="clearUpload()">ğŸ”„ Change Image</button>
              <button class="btn blue" id="btnVerifyUpload" onclick="verifyUpload()">ğŸ” Verify Document</button>
            </div>
          </div>

          <button class="btn grey" onclick="showS3a()" style="margin-top:4px;">â† Back</button>
        </div>

      </div>
    </div>

    <!-- 3c: OCR result -->
    <div id="s3c" style="display:none;">
      <div class="card">
        <p class="ctitle" id="ocrCardTitle">ğŸ” Verifying Document</p>
        <p class="csub" id="ocrCardSub">Checking name &amp; date of birthâ€¦</p>
        <div id="e3c"></div>
        <canvas id="docCanvas" style="width:100%;border-radius:12px;display:block;margin-bottom:12px;border:2px solid #e2e8f0;"></canvas>
        <div id="ocrLoading" style="text-align:center;padding:12px 0;">
          <div style="display:flex;align-items:center;justify-content:center;gap:10px;margin-bottom:8px;">
            <div class="spin-b"></div>
            <span id="ocrTxt" style="font-size:13px;font-weight:700;color:#4f46e5;">Preprocessing imageâ€¦</span>
          </div>
          <div class="prog" style="max-width:200px;"><div class="prog-f" id="ocrBar" style="width:5%;"></div></div>
        </div>
        <div id="ocrResult" style="display:none;"></div>
        <div id="ocrActions" style="display:none;margin-top:12px;">
          <button class="btn green" id="btnAccept" onclick="acceptProof()" style="display:none;">âœ… Verified â€” Continue to Face Scan</button>
          <button class="btn grey" onclick="retryDoc()" style="margin-top:8px;">ğŸ”„ Retake / Re-upload</button>
          <button class="btn grey" onclick="showS3a()" style="margin-top:8px;font-size:13px;">â† Choose Different Document</button>
        </div>
      </div>
    </div>
  </div>

  <!-- â”€â”€â”€ STEP 4: Face â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div id="step4" style="display:none;">

    <!-- Camera panel (shown immediately) -->
    <div id="s4b" style="display:none;">

      <!-- Camera selector for desktop -->
      <div id="faceCamSelectWrap" style="display:none;margin-bottom:10px;">
        <div class="card" style="padding:12px;">
          <label class="lbl">Select Camera</label>
          <select id="faceCamSelect" class="inp" style="height:44px;padding:8px 12px;" onchange="switchFaceCamera()"></select>
          <p style="font-size:11px;color:#94a3b8;margin:4px 0 0;">Black screen? Pick a different camera above.</p>
        </div>
      </div>

      <div class="face-cam" id="faceCamEl">
        <video id="faceVid" autoplay muted playsinline></video>
        <div class="cam-top">
          <span class="lx" id="faceLx">ğŸ’¡ â€”</span>
          <div style="display:flex;gap:7px;">
            <button class="icn" id="btnFlipFace" onclick="flipFaceCam()" title="Flip camera">ğŸ”„</button>
            <button class="icn" id="faceBoost" onclick="toggleFaceBoost()">â˜€ï¸</button>
          </div>
        </div>
        <div class="oval-wrap"><div class="oval" id="faceOval"></div></div>
        <!-- Countdown ring overlay -->
        <div id="cntdOverlay" style="display:none;position:absolute;inset:0;display:none;align-items:center;justify-content:center;pointer-events:none;">
          <div id="cntdNum" style="font-size:5rem;font-weight:900;color:white;text-shadow:0 0 20px rgba(0,0,0,.8);"></div>
        </div>
        <div class="face-btm">
          <div class="face-txt" id="faceTxt">ğŸ‘¤ Look straight at the camera</div>
        </div>
      </div>

      <!-- AI status bar (subtle, below camera) -->
      <div id="aiStatusBar" style="display:flex;align-items:center;gap:8px;padding:7px 12px;background:rgba(255,255,255,.07);border-radius:10px;margin-top:6px;margin-bottom:10px;">
        <div class="spin-b" id="aiSpinner" style="flex-shrink:0;"></div>
        <span id="aiStatusTxt" style="font-size:11px;color:rgba(255,255,255,.5);font-weight:600;">Loading face AI in backgroundâ€¦</span>
      </div>

      <div id="e4"></div>
      <div class="btn-row">
        <button class="btn grey" style="max-width:70px;" onclick="stopFaceCam();goStep(3)">â† Back</button>
        <button class="btn blue" id="btnFace" onclick="snapFace()">ğŸ“¸ Snap Photo</button>
      </div>
      <button class="btn grey" id="btnRetryFace" onclick="retryFaceCamera()" style="margin-top:8px;font-size:13px;background:#fef3c7;color:#92400e;display:none;">ğŸ”„ Retry / Change Camera</button>
    </div>

    <!-- Processing panel (shown after snap while AI runs) -->
    <div id="s4proc" style="display:none;">
      <div class="card" style="text-align:center;padding:30px 20px;">
        <div style="font-size:3rem;margin-bottom:12px;">ğŸ¤–</div>
        <p id="procTxt" style="font-weight:700;font-size:14px;margin-bottom:10px;">Analysing faceâ€¦</p>
        <div class="prog"><div class="prog-f" id="procBar" style="width:10%;"></div></div>
      </div>
    </div>

    <!-- Preview panel -->
    <div id="s4c" style="display:none;">
      <div class="prev"><canvas id="faceCanvas"></canvas><div class="prev-badge">âœ… Photo captured</div></div>
      <div class="al ok" style="margin-bottom:10px;">ğŸ¯ Face photo saved â€” click below to complete registration</div>
      <div class="btn-row">
        <button class="btn grey" style="max-width:110px;" onclick="retakeFace()">ğŸ”„ Retake</button>
        <button class="btn green" id="btnReg" onclick="doRegister()">âœ… Complete Registration</button>
      </div>
    </div>
  </div>

  <!-- â”€â”€â”€ STEP 5: Done â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div id="step5" style="display:none;">
    <div id="s5content"></div>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var reg={}, proofType=null, proofOK=false, finalDesc=null;
var aadhaarOK=false, panOK=false, collegeOK=false, currentDoc=null, includeCollege=false;
var faceDescs=[], faceCapturing=false, faceStream=null, faceLoop=null;
var faceModels=false, facingMode='user', faceBoostOn=false, faceLux=150;
var faceCameraId=null;
var docStream=null, docFacing='environment', docBoostOn=false, docLux=150, docLightLoop=null;
var otpCountdown=null;
var CDN1='https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/weights';
var CDN2='https://raw.githubusercontent.com/justadudewhohacks/face-api.js/master/weights';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NAVIGATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function goStep(n){
  for(var i=1;i<=5;i++){
    var el=document.getElementById('step'+i);
    if(el) el.style.display=i===n?'block':'none';
  }
  var pids=['sp1','sp2','sp3','sp4','sp5'];
  for(var j=0;j<pids.length;j++){
    var p=document.getElementById(pids[j]);
    if(p) p.className='sp'+(j+1<n?' done':j+1===n?' active':'');
  }
  window.scrollTo({top:0,behavior:'smooth'});
}
function al(id,type,msg){
  var el=document.getElementById(id);
  if(el) el.innerHTML=msg?'<div class="al '+type+'">'+msg+'</div>':'';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STEP 1 â€” Info (NO age restriction)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function s1Next(){
  al('e1','','');
  var name  = document.getElementById('fName').value.trim();
  var dob   = document.getElementById('fDob').value;
  var phone = document.getElementById('fPhone').value.replace(/\D/g,'');
  var addr  = document.getElementById('fAddr').value.trim();

  if(!name || name.length < 2){
    al('e1','err','âš ï¸ Full name is required.');
    document.getElementById('fName').focus(); return;
  }
  if(!dob){
    al('e1','err','âš ï¸ Date of birth is required.');
    document.getElementById('fDob').focus(); return;
  }
  if(phone.length < 10){
    al('e1','err','âš ï¸ Enter a valid 10-digit mobile number.');
    document.getElementById('fPhone').focus(); return;
  }

  // ES5-compatible object (no shorthand)
  reg = { name:name, dob:dob, phone:phone, address:addr };
  document.getElementById('phoneDisp').textContent = '+91 ' + phone;
  goStep(2);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STEP 2 â€” OTP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildOtp(){
  var row=document.getElementById('otpRow');
  if(!row){ console.error('otpRow not found'); return; }
  row.innerHTML='';
  for(var i=0;i<6;i++){
    (function(idx){
      var inp=document.createElement('input');
      inp.type='tel'; inp.maxLength=1; inp.className='otp-d'; inp.id='od'+idx; inp.inputMode='numeric';
      inp.addEventListener('input',function(){
        this.value=this.value.replace(/\D/g,'');
        if(this.value&&idx<5){ var nx=document.getElementById('od'+(idx+1)); if(nx) nx.focus(); }
        refreshVerify();
      });
      inp.addEventListener('keydown',function(e){
        if(e.key==='Backspace'&&!this.value&&idx>0){ var pv=document.getElementById('od'+(idx-1)); if(pv) pv.focus(); }
      });
      row.appendChild(inp);
    })(i);
  }
  row.addEventListener('paste',function(e){
    var txt=(e.clipboardData||window.clipboardData).getData('text').replace(/\D/g,'').slice(0,6);
    if(txt.length===6){for(var k=0;k<6;k++){var d=document.getElementById('od'+k);if(d){d.value=txt[k];d.className='otp-d ok';}}refreshVerify();e.preventDefault();}
  });
}

function refreshVerify(){
  var full=true;
  for(var i=0;i<6;i++){var d=document.getElementById('od'+i);if(!d||!d.value){full=false;d&&(d.className='otp-d');}else d.className='otp-d ok';}
  document.getElementById('btnVerify').disabled=!full;
}

async function sendOtp(){
  var btn=document.getElementById('btnSend');
  btn.disabled=true; btn.innerHTML='<span class="spin"></span> Sendingâ€¦';
  al('e2','','');
  try{
    var res=await fetch('/api/otp/send',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({phone:reg.phone})});
    var data=await res.json();
    if(!res.ok) throw new Error(data.error);
    document.getElementById('otpSend').style.display='none';
    document.getElementById('otpEntry').style.display='block';
    document.getElementById('od0').focus();
    if(data.demoOtp){var h=document.getElementById('otpHint');h.style.display='block';h.textContent='ğŸ“± Demo OTP: '+data.demoOtp;}
    startOtpCd(300);
    al('e2','ok','âœ… '+data.message);
  }catch(e){al('e2','err','âŒ '+e.message);btn.disabled=false;btn.innerHTML='ğŸ“¤ Send OTP';}
}

function startOtpCd(s){
  clearInterval(otpCountdown);
  otpCountdown=setInterval(function(){
    s--;var m=Math.floor(s/60),sec=s%60;
    var el=document.getElementById('otpTimer');
    if(el) el.textContent='OTP expires in '+m+':'+(sec<10?'0':'')+sec;
    if(s<=0){clearInterval(otpCountdown);if(el)el.textContent='OTP expired. Please resend.';}
  },1000);
}

function resetOtp(){
  clearInterval(otpCountdown);
  document.getElementById('otpSend').style.display='block';
  document.getElementById('otpEntry').style.display='none';
  for(var i=0;i<6;i++){var d=document.getElementById('od'+i);if(d){d.value='';d.className='otp-d';}}
  document.getElementById('otpHint').style.display='none';
  document.getElementById('btnVerify').disabled=true;
  var btn=document.getElementById('btnSend');btn.disabled=false;btn.innerHTML='ğŸ“¤ Send OTP';
  al('e2','','');
}

async function verifyOtp(){
  var otp='';for(var i=0;i<6;i++){var d=document.getElementById('od'+i);otp+=(d?d.value:'');}
  if(otp.length<6) return al('e2','err','Enter the complete 6-digit OTP.');
  var btn=document.getElementById('btnVerify');
  btn.disabled=true;btn.innerHTML='<span class="spin"></span> Verifyingâ€¦';
  al('e2','','');
  try{
    var res=await fetch('/api/otp/verify',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({phone:reg.phone,otp})});
    var data=await res.json();
    if(!res.ok) throw new Error(data.error);
    clearInterval(otpCountdown);
    reg.phoneVerified=true;
    al('e2','ok','âœ… Phone verified!');
    setTimeout(function(){goStep(3);showS3a();},700);
  }catch(e){al('e2','err','âŒ '+e.message);btn.disabled=false;btn.innerHTML='âœ… Verify OTP';}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STEP 3 â€” ID Proof
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showS3a(){
  document.getElementById('s3a').style.display='block';
  document.getElementById('s3b').style.display='none';
  document.getElementById('s3c').style.display='none';
}

function pickProof(type){
  proofType=type;
  // Reset all ticks
  ['aadhaar','pan','college'].forEach(function(t){
    var card=document.getElementById('pc-'+t);
    var tick=document.getElementById('pc-'+t+'-tick');
    if(card) card.classList.remove('sel');
    if(tick) tick.textContent='â¬œ';
  });
  // Highlight selected
  var sel=document.getElementById('pc-'+type);
  if(sel) sel.classList.add('sel');
  var tick=document.getElementById('pc-'+type+'-tick');
  if(tick) tick.textContent='ğŸ”µ';

  // Tip text
  var tips={
    aadhaar:'<div class="al info" style="margin:0;font-size:12px;">ğŸªª <strong>Aadhaar Tips:</strong> Show the <strong>FRONT</strong> of your Aadhaar card â€” photo, full name, and date of birth must all be clearly visible. Avoid glare and shadows.</div>',
    pan:'<div class="al info" style="margin:0;font-size:12px;">ğŸ’³ <strong>PAN Card Tips:</strong> Show the <strong>FRONT</strong> of your PAN card â€” full name, date of birth, and the 10-character PAN number (e.g. ABCDE1234F) must be fully visible.</div>',
    college:'<div class="al info" style="margin:0;font-size:12px;">ğŸ“ <strong>College ID Tips:</strong> Show the <strong>FRONT</strong> of your College ID â€” your full name must be visible. Date of birth is optional but improves verification score.</div>'
  };
  var tip=document.getElementById('proofTip');
  tip.style.display='block';
  tip.innerHTML=tips[type];
  document.getElementById('btnGoScan').disabled=false;
}

function startScan(){
  if(!proofType) return al('e3a','err','âš ï¸ Please select an ID document type first.');
  var titles={aadhaar:'Scan Aadhaar Card',pan:'Scan PAN Card',college:'Scan College ID Card'};
  document.getElementById('scanTitle').textContent='ğŸ“· '+titles[proofType];
  document.getElementById('scanSub').textContent='Use camera or upload a clear photo of your '+titles[proofType];
  var tips={
    aadhaar:'<div class="al info" style="margin:0;font-size:12px;">ğŸªª Hold Aadhaar card flat inside the frame â€” photo, name and DOB all visible. No shadows or glare.</div>',
    pan:'<div class="al info" style="margin:0;font-size:12px;">ğŸ’³ Hold PAN card flat â€” name, date of birth and 10-char PAN number must all be clearly visible.</div>',
    college:'<div class="al info" style="margin:0;font-size:12px;">ğŸ“ Hold College ID flat â€” your name must be clearly visible for matching.</div>'
  };
  document.getElementById('docTipBox').innerHTML=tips[proofType];

  // Update OCR card title
  var ocrTitles={aadhaar:'ğŸªª Aadhaar Card Verification',pan:'ğŸ’³ PAN Card Verification',college:'ğŸ“ College ID Verification'};
  document.getElementById('ocrCardTitle').textContent=ocrTitles[proofType];
  document.getElementById('ocrCardSub').textContent='Extracting and matching Name & Date of Birth from your documentâ€¦';

  document.getElementById('s3a').style.display='none';
  document.getElementById('s3b').style.display='block';
  document.getElementById('s3c').style.display='none';
  switchTab(isMobile?'cam':'upload');
}

// â”€â”€â”€ Tab switcher â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchTab(tab){
  var isCam = tab==='cam';
  // Tab buttons
  var btnCam=document.getElementById('tabCam'), btnUp=document.getElementById('tabUpload');
  btnCam.style.borderColor  = isCam?'#4f46e5':'#e2e8f0';
  btnCam.style.background   = isCam?'#eef2ff':'#f8fafc';
  btnCam.style.color        = isCam?'#4f46e5':'#64748b';
  btnUp.style.borderColor   = isCam?'#e2e8f0':'#4f46e5';
  btnUp.style.background    = isCam?'#f8fafc':'#eef2ff';
  btnUp.style.color         = isCam?'#64748b':'#4f46e5';
  // Content panels
  document.getElementById('tabCamContent').style.display    = isCam?'block':'none';
  document.getElementById('tabUploadContent').style.display = isCam?'none':'block';
  // Start / stop camera
  if(isCam){
    openDocCam();
  } else {
    stopDocCam();
  }
}

// â”€â”€â”€ File upload handlers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function handleDrop(e){
  e.preventDefault();
  var zone=document.getElementById('uploadZone');
  zone.style.borderColor='#cbd5e1';zone.style.background='#f8fafc';
  var file=e.dataTransfer.files[0];
  if(file) loadUploadedFile(file);
}

function handleFileUpload(e){
  var file=e.target.files[0];
  if(file) loadUploadedFile(file);
}

function loadUploadedFile(file){
  if(!file.type.match(/image\/(jpeg|jpg|png)/i)){
    al('e3b','err','Only JPG or PNG images are accepted.');return;
  }
  if(file.size>10*1024*1024){
    al('e3b','err','File too large. Maximum size is 10MB.');return;
  }
  al('e3b','','');
  var reader=new FileReader();
  reader.onload=function(e){
    var img=document.getElementById('uploadImg');
    img.src=e.target.result;
    img.onload=function(){
      document.getElementById('uploadZone').style.display='none';
      document.getElementById('uploadPreview').style.display='block';
    };
  };
  reader.readAsDataURL(file);
}

function clearUpload(){
  document.getElementById('fileInput').value='';
  document.getElementById('uploadPreview').style.display='none';
  document.getElementById('uploadZone').style.display='block';
  al('e3b','','');
}

async function verifyUpload(){
  var img=document.getElementById('uploadImg');
  if(!img.src||img.src===window.location.href){
    al('e3b','err','Please upload an image first.');return;
  }
  var btn=document.getElementById('btnVerifyUpload');
  btn.disabled=true;btn.innerHTML='<span class="spin-b"></span> Processingâ€¦';

  // Draw uploaded image to canvas for OCR
  var cnv=document.getElementById('docCanvas');
  cnv.width=img.naturalWidth||img.width;
  cnv.height=img.naturalHeight||img.height;
  var ctx=cnv.getContext('2d');
  // Enhance for OCR
  ctx.filter='brightness(1.3) contrast(1.2)';
  ctx.drawImage(img,0,0);

  // Move to OCR step
  document.getElementById('s3b').style.display='none';
  document.getElementById('s3c').style.display='block';
  document.getElementById('ocrLoading').style.display='block';
  document.getElementById('ocrResult').style.display='none';
  document.getElementById('ocrActions').style.display='none';
  btn.disabled=false;btn.innerHTML='ğŸ” Verify Document';
  await runOCR(cnv);
}

function retryDoc(){
  document.getElementById('s3c').style.display='none';
  document.getElementById('s3b').style.display='block';
  document.getElementById('btnCap').disabled=false;
  document.getElementById('btnCap').innerHTML='ğŸ“¸ Capture';
  document.getElementById('docFrame').className='doc-frame';
  clearUpload();
  // Re-open whichever tab was active
  var camVisible=document.getElementById('tabCamContent').style.display!=='none';
  if(camVisible){ openDocCam(); } else { document.getElementById('uploadZone').style.display='block'; }
}

// â”€â”€â”€ Device detection â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var isMobile = /Android|iPhone|iPad|iPod|Mobile/i.test(navigator.userAgent);
var availableCameras = [];   // list of {deviceId, label}
var selectedCameraId = null;

async function detectCameras(){
  try{
    // Must request permission first so labels are readable
    var tmpStream = await navigator.mediaDevices.getUserMedia({video:true});
    tmpStream.getTracks().forEach(function(t){t.stop();});
    var devices = await navigator.mediaDevices.enumerateDevices();
    availableCameras = devices
      .filter(function(d){return d.kind==='videoinput';})
      .map(function(d,i){return {deviceId:d.deviceId, label:d.label||('Camera '+(i+1))};});
  }catch(e){ availableCameras=[]; }
}

function populateCameraSelect(){
  var wrap = document.getElementById('camSelectWrap');
  var sel  = document.getElementById('camSelect');
  if(availableCameras.length === 0){ wrap.style.display='none'; return; }

  sel.innerHTML='';

  // Score each camera â€” higher = better default choice
  function scoreCamera(cam){
    var lbl = cam.label.toLowerCase();
    if(/virtual|obs|snap|ivcam|droid|vivo|samsung|iphone|android|phone|mirror|ndi|xsplit|manycam/i.test(lbl)) return -10; // virtual/phone cameras â€” avoid
    if(/integrated|built.?in|internal|laptop|hd webcam|ir camera|webcam/i.test(lbl)) return 10; // built-in laptop cam â€” prefer
    if(/back|rear|environment/i.test(lbl) && isMobile) return 8;  // rear cam on mobile
    if(/usb|external/i.test(lbl)) return 3;
    return 1; // unknown â€” neutral
  }

  // Sort: best score first
  var sorted = availableCameras.slice().sort(function(a,b){ return scoreCamera(b)-scoreCamera(a); });

  sorted.forEach(function(cam, i){
    var opt = document.createElement('option');
    opt.value = cam.deviceId;
    var lbl = cam.label;
    var score = scoreCamera(cam);
    var prefix;
    if(score === -10)     prefix = 'âš ï¸ Virtual/Phone â€” ';
    else if(score >= 10)  prefix = 'âœ… Laptop Webcam â€” ';
    else if(/back|rear/i.test(lbl) && isMobile) prefix = 'ğŸ“· Rear Camera â€” ';
    else if(/front|user/i.test(lbl) && isMobile) prefix = 'ğŸ¤³ Front Camera â€” ';
    else                  prefix = 'ğŸ“· Camera '+(i+1)+' â€” ';
    opt.textContent = prefix + lbl;
    sel.appendChild(opt);
  });

  // Auto-select the best camera (first after sorting)
  sel.selectedIndex = 0;
  selectedCameraId = sel.value;

  // Always show selector if there are multiple cameras
  wrap.style.display = availableCameras.length > 1 ? 'block' : 'none';
}

async function switchCamera(){
  selectedCameraId = document.getElementById('camSelect').value;
  // Warn if they picked a virtual/phone camera
  var cam = availableCameras.find(function(c){ return c.deviceId===selectedCameraId; });
  var isVirtual = cam && /virtual|obs|snap|ivcam|droid|vivo|samsung|iphone|android|phone|mirror|ndi|xsplit|manycam/i.test(cam.label);
  var tip = document.getElementById('deviceTip');
  if(isVirtual){
    tip.style.display='block';
    tip.innerHTML='<div class="al warn" style="margin:0;font-size:12px;">âš ï¸ <strong>Virtual/Phone camera selected.</strong> This may not work for document scanning. Please select your <strong>Laptop Webcam</strong> from the dropdown above for best results.</div>';
  }
  stopDocCam();
  await openDocCam();
}

// â”€â”€â”€ Document Camera â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function openDocCam(){
  document.getElementById('docLoading').style.display='block';
  document.getElementById('docCamWrap').style.display='none';
  document.getElementById('docLoadTxt').textContent='Detecting camerasâ€¦';
  al('e3b','','');

  if(availableCameras.length===0) await detectCameras();
  populateCameraSelect();

  document.getElementById('docLoadTxt').textContent='Starting cameraâ€¦';

  // Try a cascade of resolutions â€” HP HD Camera and most laptop webcams only do 720p or lower.
  // We never force a resolution that might not be supported.
  var fallbacks;
  if(selectedCameraId){
    fallbacks = [
      {video:{deviceId:{exact:selectedCameraId},width:{ideal:1280},height:{ideal:720}}},
      {video:{deviceId:{exact:selectedCameraId},width:{ideal:640}, height:{ideal:480}}},
      {video:{deviceId:{exact:selectedCameraId}}},  // bare minimum â€” just open it
    ];
  } else if(isMobile){
    fallbacks = [
      {video:{facingMode:{ideal:'environment'},width:{ideal:1920},height:{ideal:1080},advanced:[{focusMode:'continuous'}]}},
      {video:{facingMode:{ideal:'environment'},width:{ideal:1280},height:{ideal:720}}},
      {video:{facingMode:{ideal:'environment'}}},
    ];
  } else {
    fallbacks = [
      {video:{width:{ideal:1280},height:{ideal:720}}},
      {video:{width:{ideal:640}, height:{ideal:480}}},
      {video:true},
    ];
  }

  docStream = null;
  for(var fi=0; fi<fallbacks.length; fi++){
    document.getElementById('docLoadTxt').textContent = fi===0 ? 'Starting cameraâ€¦' : 'Retrying (attempt '+(fi+1)+') â€¦';
    try{
      docStream = await navigator.mediaDevices.getUserMedia(fallbacks[fi]);
      console.log('Camera started with fallback', fi, fallbacks[fi]);
      break;
    }catch(err){
      console.warn('Camera attempt '+(fi+1)+' failed:', err.message);
    }
  }

  if(!docStream){
    document.getElementById('docLoading').style.display='none';
    showCameraError();
    return;
  }

  var v=document.getElementById('docVid');
  v.srcObject=docStream; v.play();
  applyDocFilter();

  document.getElementById('btnFlipDoc').style.display = isMobile ? 'flex' : 'none';

  var bar  = document.getElementById('docBar');
  var hint = document.getElementById('docHint');
  var tip  = document.getElementById('deviceTip');

  // Check if selected cam is virtual/phone
  var selCam = availableCameras.find(function(c){return c.deviceId===selectedCameraId;});
  var isVirtualCam = selCam && /virtual|obs|snap|ivcam|droid|vivo|samsung|iphone|android|phone|mirror|ndi|xsplit|manycam/i.test(selCam.label);

  if(isMobile){
    bar.textContent  = 'ğŸ“„ Place document flat â€” all 4 corners inside the frame';
    hint.textContent = 'ğŸ”„ flip camera Â· â˜€ï¸ boost light Â· Keep document flat, no glare';
    tip.style.display = 'none';
  } else {
    bar.textContent  = 'ğŸ“„ Hold document up to your webcam â€” fill the frame';
    hint.textContent = 'Hold document flat facing your webcam Â· Good lighting Â· Keep steady';
    if(isVirtualCam){
      tip.style.display='block';
      tip.innerHTML='<div class="al warn" style="margin:0;font-size:13px;">âš ï¸ <strong>Phone/Virtual camera detected.</strong> This may show a black screen.<br><br>'
        +'ğŸ‘‰ <strong>Try the Upload Photo tab instead</strong> â€” much more reliable on laptops.'
        +'<br><button onclick="switchTab(\'upload\')" style="margin-top:8px;background:#4f46e5;color:white;border:none;border-radius:8px;padding:8px 16px;font-weight:700;cursor:pointer;font-size:13px;">ğŸ“ Switch to Upload Photo</button></div>';
    } else {
      tip.style.display='block';
      tip.innerHTML='<div class="al info" style="margin:0;font-size:12px;">ğŸ’» <strong>Laptop/PC mode:</strong> Hold your ID flat up to your webcam. All text must be clearly readable.</div>';
    }
  }

  document.getElementById('docLoading').style.display='none';
  document.getElementById('docCamWrap').style.display='block';
  startDocLight();

  // â”€â”€ // â”€â”€ Black screen detector â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // HP HD Camera and some webcams take a few seconds to produce a frame.
  // Check at 2s, then again at 4s before declaring failure.
  function checkBlack(vid){
    try{
      var c=document.createElement('canvas');c.width=80;c.height=50;
      var ctx=c.getContext('2d');ctx.drawImage(vid,0,0,80,50);
      var px=ctx.getImageData(0,0,80,50).data,s=0;
      for(var i=0;i<px.length;i+=4) s+=(px[i]+px[i+1]+px[i+2])/3;
      return s/(px.length/4);
    }catch(e){return 128;}
  }
  setTimeout(function(){
    if(!docStream) return;
    if(checkBlack(v)<6){
      // Still black at 2s -- give it 2 more seconds then auto-retry
      setTimeout(function(){
        if(!docStream) return;
        if(checkBlack(v)<6) showBlackScreenWarning();
      },2000);
    }
  },2000);
}
function showBlackScreenWarning(){
  // Black screen on HP cam usually means wrong resolution was forced.
  // Show actionable message with retry button â€” NOT upload.
  var tip = document.getElementById('deviceTip');
  tip.style.display='block';
  tip.innerHTML='<div class="al err" style="margin:0;font-size:13px;">'
    +'<strong>Camera showing black screen.</strong> Trying to fix automatically...<br><br>'
    +'<button onclick="retryCameraLowRes()" style="width:100%;background:#4f46e5;color:white;border:none;border-radius:10px;padding:11px;font-weight:700;cursor:pointer;font-size:14px;margin-bottom:8px;">ğŸ”„ Retry Camera (Auto-fix)</button>'
    +(availableCameras.length>1?'<div style="font-size:12px;color:#7f1d1d;margin-top:4px;">Or pick a different camera from the SELECT CAMERA dropdown above.</div>':'')
    +'</div>';
  // Also auto-retry after 500ms
  setTimeout(retryCameraLowRes, 500);
}

async function retryCameraLowRes(){
  // Stop current dead stream and restart with bare minimum constraints
  stopDocCam();
  document.getElementById('deviceTip').style.display='none';
  document.getElementById('docLoading').style.display='block';
  document.getElementById('docCamWrap').style.display='none';
  document.getElementById('docLoadTxt').textContent='Retrying with lower resolution...';
  try{
    // Use absolute minimum â€” no resolution hints at all
    var constraint = selectedCameraId
      ? {video:{deviceId:{exact:selectedCameraId}}}
      : {video:true};
    docStream = await navigator.mediaDevices.getUserMedia(constraint);
    var v=document.getElementById('docVid');
    v.srcObject=docStream;
    await v.play();
    applyDocFilter();
    document.getElementById('docLoading').style.display='none';
    document.getElementById('docCamWrap').style.display='block';
    document.getElementById('btnFlipDoc').style.display = isMobile ? 'flex' : 'none';
    startDocLight();
    var tip=document.getElementById('deviceTip');
    tip.style.display='block';
    tip.innerHTML='<div class="al ok" style="margin:0;font-size:12px;">âœ… Camera started! Hold your ID up to the webcam, fill the frame, then click Capture.</div>';
  }catch(e){
    document.getElementById('docLoading').style.display='none';
    showCameraError();
  }
}

function showCameraError(){
  var tip = document.getElementById('deviceTip');
  tip.style.display='block';
  tip.innerHTML='<div class="al err" style="margin:0;font-size:13px;">'
    +'ğŸ“· <strong>Camera could not be started.</strong><br><br>'
    +'<strong>Things to try:</strong><br>'
    +'<ul style="margin:8px 0 8px 16px;font-size:12px;color:#7f1d1d;">'
    +'<li>Close any other apps using the camera (Zoom, Teams, etc.)</li>'
    +'<li>Click the camera icon in your browser address bar and allow access</li>'
    +'<li>Try a different browser (Chrome works best)</li>'
    +'<li>Restart your browser and try again</li>'
    +'</ul>'
    +'<button onclick="retryCameraLowRes()" style="width:100%;background:#4f46e5;color:white;border:none;border-radius:10px;padding:11px;font-weight:700;cursor:pointer;font-size:14px;">ğŸ”„ Try Again</button>'
    +'</div>';
  document.getElementById('docCamWrap').style.display='none';
  document.getElementById('docLoading').style.display='none';
}

function applyDocFilter(){
  var v=document.getElementById('docVid');
  if(v) v.style.filter=docBoostOn?'brightness(2.2) contrast(1.7) saturate(0.8)':'brightness(1.4) contrast(1.2)';
}

function flipDocCam(){
  // Mobile only: toggle front/back
  stopDocCam();
  docFacing = docFacing==='environment'?'user':'environment';
  selectedCameraId = null; // clear so facingMode constraint is used
  openDocCam();
}

function toggleDocBoost(){docBoostOn=!docBoostOn;document.getElementById('docBoost').classList.toggle('on',docBoostOn);applyDocFilter();}

function startDocLight(){
  clearInterval(docLightLoop);
  docLightLoop=setInterval(function(){
    var v=document.getElementById('docVid');if(!v||!v.videoWidth)return;
    try{
      var c=document.createElement('canvas');c.width=80;c.height=50;
      var ctx=c.getContext('2d');ctx.drawImage(v,0,0,80,50);
      var px=ctx.getImageData(0,0,80,50).data,s=0;
      for(var i=0;i<px.length;i+=16)s+=(px[i]+px[i+1]+px[i+2])/3;
      docLux=s/(px.length/16);
      var chip=document.getElementById('docLx');if(!chip)return;
      if(docLux<50){chip.textContent='ğŸŒ‘ Very Dark';chip.style.background='rgba(120,53,15,.85)';if(!docBoostOn){docBoostOn=true;applyDocFilter();document.getElementById('docBoost').classList.add('on');}}
      else if(docLux<90){chip.textContent='ğŸŒ™ Low';chip.style.background='rgba(100,50,0,.85)';}
      else if(docLux<160){chip.textContent='ğŸ’¡ OK';chip.style.background='rgba(0,0,0,.6)';}
      else{chip.textContent='â˜€ï¸ Good';chip.style.background='rgba(5,80,40,.85)';}
    }catch(e){}
  },800);
}

function stopDocCam(){
  clearInterval(docLightLoop);docLightLoop=null;
  if(docStream){docStream.getTracks().forEach(function(t){t.stop();});docStream=null;}
}

// â”€â”€â”€ Capture & OCR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function captureDoc(){
  var btn=document.getElementById('btnCap');
  btn.disabled=true;btn.innerHTML='<span class="spin-b"></span> Capturingâ€¦';
  document.getElementById('docFrame').className='doc-frame scan';
  await new Promise(function(r){setTimeout(r,500);});

  var vid=document.getElementById('docVid');
  var cnv=document.getElementById('docCanvas');
  cnv.width=vid.videoWidth||1280;cnv.height=vid.videoHeight||720;
  var ctx=cnv.getContext('2d');

  // On laptop/PC the webcam image is often mirrored â€” un-mirror it for OCR
  var track = docStream && docStream.getVideoTracks()[0];
  var settings = track ? track.getSettings() : {};
  var facingEnv = settings.facingMode==='environment' || (!isMobile && docFacing!=='user');

  if(!isMobile && !facingEnv){
    // Un-mirror: flip horizontally so text reads correctly
    ctx.save();
    ctx.translate(cnv.width, 0);
    ctx.scale(-1, 1);
  }

  // Apply lighting enhancement
  var bri=docLux<70?2.2:docLux<120?1.7:1.4;
  var con=docLux<70?2.0:docLux<120?1.6:1.3;
  ctx.filter='brightness('+bri+') contrast('+con+')';
  ctx.drawImage(vid,0,0);

  if(!isMobile && !facingEnv) ctx.restore();

  document.getElementById('docFrame').className='doc-frame good';
  stopDocCam();
  document.getElementById('s3b').style.display='none';
  document.getElementById('s3c').style.display='block';
  document.getElementById('ocrLoading').style.display='block';
  document.getElementById('ocrResult').style.display='none';
  document.getElementById('ocrActions').style.display='none';
  await runOCR(cnv);
}

// â”€â”€â”€ Advanced image preprocessing before OCR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function preprocessForOCR(srcCanvas){
  var W=srcCanvas.width,H=srcCanvas.height;
  var dst=document.createElement('canvas');
  var scale=Math.max(1,Math.min(2, 1600/Math.max(W,H)));
  dst.width=Math.round(W*scale); dst.height=Math.round(H*scale);
  var ctx=dst.getContext('2d');

  // Step 1: upscale with smoothing
  ctx.imageSmoothingEnabled=true; ctx.imageSmoothingQuality='high';
  ctx.drawImage(srcCanvas,0,0,dst.width,dst.height);

  // Step 2: get pixel data
  var idata=ctx.getImageData(0,0,dst.width,dst.height);
  var px=idata.data,n=px.length;

  // Step 3: grayscale + contrast stretch + adaptive threshold
  var grays=new Uint8Array(n/4);
  var mn=255,mx=0;
  for(var i=0;i<n;i+=4){
    // Luminance-weighted grayscale
    var g=Math.round(0.299*px[i]+0.587*px[i+1]+0.114*px[i+2]);
    grays[i/4]=g;
    if(g<mn)mn=g; if(g>mx)mx=g;
  }

  // Auto-level (stretch contrast)
  var rng=mx-mn||1;
  for(var j=0;j<grays.length;j++) grays[j]=Math.round((grays[j]-mn)/rng*255);

  // Write back sharpened grayscale
  for(var k=0;k<n;k+=4){
    var v=grays[k/4];
    // Soft threshold to improve text clarity
    v = v < 128 ? Math.max(0, v*0.7) : Math.min(255, 50 + v*0.8);
    px[k]=px[k+1]=px[k+2]=v; px[k+3]=255;
  }
  ctx.putImageData(idata,0,0);

  // Step 4: unsharp mask (simple version via shadow canvas)
  var blur=document.createElement('canvas');blur.width=dst.width;blur.height=dst.height;
  var bctx=blur.getContext('2d');
  bctx.filter='blur(1.5px)'; bctx.drawImage(dst,0,0);
  var bi=bctx.getImageData(0,0,dst.width,dst.height).data;
  var sharp=ctx.getImageData(0,0,dst.width,dst.height);
  var sp=sharp.data;
  for(var s=0;s<sp.length;s+=4){
    sp[s]  =Math.min(255,Math.max(0, sp[s]  *1.8 - bi[s]  *0.8));
    sp[s+1]=Math.min(255,Math.max(0, sp[s+1]*1.8 - bi[s+1]*0.8));
    sp[s+2]=Math.min(255,Math.max(0, sp[s+2]*1.8 - bi[s+2]*0.8));
  }
  ctx.putImageData(sharp,0,0);
  return dst;
}

async function runOCR(canvas){
  if(typeof Tesseract==='undefined'){
    document.getElementById('ocrTxt').textContent='Loading OCR engineâ€¦';
    await loadScript('https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js');
  }
  try{
    document.getElementById('ocrTxt').textContent='Preprocessing imageâ€¦';
    document.getElementById('ocrBar').style.width='8%';

    // Run on BOTH original (colour) and preprocessed (b&w) â€” take best result
    var preprocessed=preprocessForOCR(canvas);

    document.getElementById('ocrTxt').textContent='Running OCRâ€¦';
    document.getElementById('ocrBar').style.width='15%';

    var worker=await Tesseract.createWorker('eng',1,{
      logger:function(m){
        if(m.status==='recognizing text'){
          var p=Math.round(m.progress*70)+20;
          document.getElementById('ocrBar').style.width=p+'%';
          document.getElementById('ocrTxt').textContent='Reading textâ€¦ '+p+'%';
        }
      }
    });

    await worker.setParameters({
      tessedit_char_whitelist:'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789:/- ',
      preserve_interword_spaces:'1',
    });

    // Run OCR on preprocessed image
    var r1=await worker.recognize(preprocessed);
    // Run OCR on original for comparison
    var r2=await worker.recognize(canvas);
    await worker.terminate();

    // Merge both texts
    var combined=r1.data.text+'\n'+r2.data.text;
    document.getElementById('ocrBar').style.width='100%';
    document.getElementById('ocrTxt').textContent='Analysingâ€¦';
    await new Promise(function(r){setTimeout(r,400);});
    showOCRResult(combined, r1.data.confidence);

  }catch(e){
    document.getElementById('ocrLoading').style.display='none';
    document.getElementById('ocrResult').style.display='block';
    document.getElementById('ocrResult').innerHTML='<div class="al err">âŒ OCR failed: '+e.message+'. Try better lighting.</div>';
    document.getElementById('ocrActions').style.display='block';
    document.getElementById('btnAccept').style.display='none';
  }
}

// â”€â”€â”€ OCR Result Analysis â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showOCRResult(rawText, confidence){
  document.getElementById('ocrLoading').style.display='none';
  document.getElementById('ocrResult').style.display='block';
  document.getElementById('ocrActions').style.display='block';

  var text=rawText;
  var textUP=text.toUpperCase();

  // â”€â”€ Detect document type â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  var detectedAadhaar = /UNIQUE\s*IDENT|GOVERNMENT\s*OF\s*INDIA|UIDAI|AADHAAR|\d{4}\s*\d{4}\s*\d{4}/i.test(text);
  var detectedPAN     = /INCOME\s*TAX|PERMANENT\s*ACCOUNT|GOVT\s*OF\s*INDIA|[A-Z]{5}[0-9]{4}[A-Z]/i.test(text);

  // â”€â”€ Extract Aadhaar number (12 digits) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  var aadhaarNum=null;
  var anm=text.match(/\b(\d{4})\s*(\d{4})\s*(\d{4})\b/);
  if(anm) aadhaarNum=anm[1]+' '+anm[2]+' '+anm[3];

  // â”€â”€ Extract PAN number (XXXXX9999X format) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  var panNum=null;
  var pnm=text.match(/\b([A-Z]{5}[0-9]{4}[A-Z])\b/);
  if(pnm) panNum=pnm[1];

  // â”€â”€ Extract DOB â€” Aadhaar DD/MM/YYYY, PAN DD/MM/YYYY â”€â”€â”€â”€â”€â”€â”€
  var dobRaw=null, dobISO=null;
  var dobPatterns=[
    /\bDOB\s*[:\-]?\s*(\d{1,2}[\/\-\.]\d{1,2}[\/\-\.]\d{4})\b/i,
    /\bDate\s*of\s*Birth\s*[:\-]?\s*(\d{1,2}[\/\-\.]\d{1,2}[\/\-\.]\d{4})\b/i,
    /\bBirth\s*Date\s*[:\-]?\s*(\d{1,2}[\/\-\.]\d{1,2}[\/\-\.]\d{4})\b/i,
    /\bBirth\s*[:\-]?\s*(\d{1,2}[\/\-\.]\d{1,2}[\/\-\.]\d{4})\b/i,
    // PAN card shows date as DD/MM/YYYY after "Date of Birth" line
    /(\d{2}[\/\-\.]\d{2}[\/\-\.]\d{4})/,
    /\bYear\s*of\s*Birth\s*[:\-]?\s*(\d{4})\b/i,
    /\bYOB\s*[:\-]?\s*(\d{4})\b/i,
    /\bAge\s*[:\-]\s*(\d{1,3})\b/i,
  ];

  for(var pi=0;pi<dobPatterns.length;pi++){
    var m=text.match(dobPatterns[pi]);
    if(!m) continue;
    var val=m[1];
    if(dobPatterns[pi].source.indexOf('Age')>-1){
      var yr=new Date().getFullYear()-parseInt(val);
      dobISO=yr+'-01-01'; dobRaw='~Age '+val+' (Born ~'+yr+')'; break;
    }
    var parts=val.split(/[\/\-\.]/);
    if(parts.length===3){
      if(parts[2].length===4){
        dobISO=parts[2]+'-'+parts[1].padStart(2,'0')+'-'+parts[0].padStart(2,'0');
        dobRaw=val; break;
      } else if(parts[0].length===4){
        dobISO=parts[0]+'-'+parts[1].padStart(2,'0')+'-'+parts[2].padStart(2,'0');
        dobRaw=val; break;
      }
    } else if(parts.length===1&&val.length===4){
      dobISO=val+'-01-01'; dobRaw='Year: '+val; break;
    }
  }

  // â”€â”€ DOB match â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  var dobMatch=false, dobPartial=false;
  if(dobISO&&reg.dob){
    var regDate=new Date(reg.dob), extDate=new Date(dobISO);
    var diffMs=Math.abs(regDate-extDate);
    dobMatch = diffMs < 2*24*60*60*1000;
    if(!dobMatch && dobISO.slice(0,4)===reg.dob.slice(0,4)) dobPartial=true;
  }

  // â”€â”€ Name match (scored 0â€“1) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  var foundName='', bestScore=0;
  var lines=text.split('\n');
  var regWords=reg.name.toUpperCase().split(/\s+/).filter(function(w){return w.length>1;});
  for(var li=0;li<lines.length;li++){
    var lineUp=lines[li].toUpperCase().replace(/[^A-Z\s]/g,'').trim();
    if(lineUp.length<3) continue;
    var hits=0;
    for(var wi=0;wi<regWords.length;wi++) if(lineUp.indexOf(regWords[wi])>=0) hits++;
    var score=hits/Math.max(1,regWords.length);
    if(score>bestScore){bestScore=score;foundName=lines[li].trim();}
  }
  var nameMatch = bestScore>=0.8;

  // â”€â”€ Doc type authentication â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  var hasAuthMarker = proofType==='aadhaar'
    ? (detectedAadhaar||!!aadhaarNum)
    : proofType==='pan'
    ? (detectedPAN||!!panNum)
    : true; // College ID â€” no specific marker needed

  // â”€â”€ SCORING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  var isCollege = (proofType === 'college');
  var scoreTotal = 0;
  if(dobMatch)        scoreTotal += 55;
  else if(dobPartial) scoreTotal +=  5;
  else if(isCollege)  scoreTotal += 30; // College: no DOB is acceptable
  scoreTotal += Math.round(bestScore * 35);
  if(hasAuthMarker)   scoreTotal += 10;
  scoreTotal = Math.min(100, scoreTotal);

  // College only needs 80% name match; Aadhaar/PAN need full DOB + 80% overall
  var accepted = isCollege ? (bestScore >= 0.8) : (dobMatch && scoreTotal >= 80);

  // â”€â”€ Registered DOB formatted nicely â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  var regDobFmt = reg.dob ? (function(){
    var p=reg.dob.split('-'); return p.length===3?p[2]+'/'+p[1]+'/'+p[0]:reg.dob;
  })() : 'â€”';

  // â”€â”€ Name percentage for display â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  var namePct = Math.round(bestScore * 100);

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // BUILD RESULT HTML â€” Clear Name + DOB Verification Panels
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  var docTypeLabels = {aadhaar:'Aadhaar Card',pan:'PAN Card',college:'College ID Card'};
  var docIcon = {aadhaar:'ğŸªª',pan:'ğŸ’³',college:'ğŸ“'};
  var html = '';

  // â”€â”€â”€ Overall status banner â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if(accepted){
    html += '<div style="background:linear-gradient(135deg,#f0fdf4,#dcfce7);border:2px solid #10b981;border-radius:14px;padding:16px;display:flex;align-items:center;gap:14px;margin-bottom:16px;">'
      + '<div style="font-size:2.4rem;">âœ…</div>'
      + '<div><div style="font-weight:900;font-size:15px;color:#15803d;">'+(docTypeLabels[proofType]||'Document')+' Verified!</div>'
      + '<div style="font-size:12px;color:#16a34a;margin-top:3px;">Match score: <strong>'+scoreTotal+'%</strong> â€” All checks passed</div></div></div>';
  } else {
    var banner_icon = scoreTotal>=50?'âš ï¸':'âŒ';
    var banner_bg   = scoreTotal>=50?'#fefce8,#fef9c3':'#fef2f2,#fee2e2';
    var banner_bdr  = scoreTotal>=50?'#f59e0b':'#ef4444';
    var banner_hd   = scoreTotal>=50?'#92400e':'#b91c1c';
    var banner_sub  = scoreTotal>=50?'#a16207':'#dc2626';
    html += '<div style="background:linear-gradient(135deg,'+banner_bg+');border:2px solid '+banner_bdr+';border-radius:14px;padding:16px;display:flex;align-items:center;gap:14px;margin-bottom:16px;">'
      + '<div style="font-size:2.4rem;">'+banner_icon+'</div>'
      + '<div><div style="font-weight:900;font-size:15px;color:'+banner_hd+';">Verification Failed</div>'
      + '<div style="font-size:12px;color:'+banner_sub+';margin-top:3px;">Score: <strong>'+scoreTotal+'%</strong> â€” Need 80% to pass</div></div></div>';
  }

  // â”€â”€â”€ Overall score bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  html += '<div style="background:#f8fafc;border:1px solid #e2e8f0;border-radius:12px;padding:14px;margin-bottom:14px;">'
    + '<div style="display:flex;justify-content:space-between;font-size:12px;font-weight:700;color:#64748b;margin-bottom:8px;">'
    + '<span>Overall Match Score</span><span style="color:'+(accepted?'#15803d':scoreTotal>=50?'#92400e':'#b91c1c')+'">'+scoreTotal+'% / 100%</span></div>'
    + '<div style="background:#e2e8f0;border-radius:99px;height:12px;overflow:hidden;">'
    + '<div style="height:12px;border-radius:99px;transition:width .6s;width:'+scoreTotal+'%;background:'+(accepted?'linear-gradient(90deg,#10b981,#059669)':scoreTotal>=50?'linear-gradient(90deg,#f59e0b,#d97706)':'linear-gradient(90deg,#ef4444,#dc2626)')+'"></div></div>'
    + '<div style="display:flex;justify-content:space-between;font-size:10px;color:#94a3b8;margin-top:4px;"><span>0%</span><span style="color:#f59e0b;">80% threshold</span><span>100%</span></div>'
    + '</div>';

  // â”€â”€â”€ NAME Verification Panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  html += '<div style="border:2px solid '+(nameMatch?'#10b981':'#ef4444')+';border-radius:14px;overflow:hidden;margin-bottom:12px;">'
    // Header
    + '<div style="background:'+(nameMatch?'#f0fdf4':'#fef2f2')+';padding:12px 16px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid '+(nameMatch?'#bbf7d0':'#fecaca')+';">'
    + '<div style="display:flex;align-items:center;gap:8px;">'
    + '<span style="font-size:1.2rem;">ğŸ‘¤</span>'
    + '<span style="font-weight:800;font-size:13px;color:#0f172a;">Name Verification</span>'
    + '</div>'
    + '<div style="display:flex;align-items:center;gap:6px;">'
    + '<span style="font-size:10px;font-weight:800;padding:3px 10px;border-radius:99px;background:'+(nameMatch?'#dcfce7':'#fee2e2')+';color:'+(nameMatch?'#15803d':'#b91c1c')+'">'+(nameMatch?'MATCHED':'NOT MATCHED')+'</span>'
    + '<span style="font-size:11px;font-weight:700;color:'+(nameMatch?'#15803d':'#b91c1c')+'">'+namePct+'%</span>'
    + '</div></div>'
    // Body
    + '<div style="padding:14px 16px;">'
    // Registered name row
    + '<div style="margin-bottom:10px;">'
    + '<div style="font-size:10px;font-weight:800;text-transform:uppercase;letter-spacing:.06em;color:#64748b;margin-bottom:4px;">ğŸ“‹ Your Registered Name</div>'
    + '<div style="font-size:15px;font-weight:800;color:#0f172a;background:#f1f5f9;padding:10px 14px;border-radius:8px;">'+reg.name+'</div>'
    + '</div>'
    // Extracted name row
    + '<div style="margin-bottom:10px;">'
    + '<div style="font-size:10px;font-weight:800;text-transform:uppercase;letter-spacing:.06em;color:#64748b;margin-bottom:4px;">ğŸ” Extracted from '+(docTypeLabels[proofType]||'Document')+'</div>'
    + '<div style="font-size:15px;font-weight:800;color:'+(foundName?'#0f172a':'#94a3b8')+';background:#f1f5f9;padding:10px 14px;border-radius:8px;">'+(foundName||'Could not read name from image')+'</div>'
    + '</div>'
    // Name match bar
    + '<div style="font-size:11px;color:#64748b;margin-bottom:5px;font-weight:700;">Word Match: '+namePct+'% (need â‰¥80%)</div>'
    + '<div style="background:#e2e8f0;border-radius:99px;height:8px;overflow:hidden;">'
    + '<div style="height:8px;border-radius:99px;width:'+namePct+'%;background:'+(nameMatch?'#10b981':namePct>=50?'#f59e0b':'#ef4444')+'"></div></div>'
    + '</div></div>';

  // â”€â”€â”€ DOB Verification Panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  var dobColor = dobMatch?'#10b981':dobPartial?'#f59e0b':'#ef4444';
  var dobBg    = dobMatch?'#f0fdf4':dobPartial?'#fefce8':'#fef2f2';
  var dobBdr   = dobMatch?'#bbf7d0':dobPartial?'#fde68a':'#fecaca';
  var dobHdBg  = dobMatch?'#f0fdf4':dobPartial?'#fefce8':'#fef2f2';
  var dobStatus= dobMatch?'MATCHED':dobPartial?'YEAR ONLY':'NOT FOUND';
  var dobStatusBg = dobMatch?'#dcfce7':dobPartial?'#fef9c3':'#fee2e2';
  var dobStatusC  = dobMatch?'#15803d':dobPartial?'#92400e':'#b91c1c';

  html += '<div style="border:2px solid '+dobColor+';border-radius:14px;overflow:hidden;margin-bottom:12px;">'
    // Header
    + '<div style="background:'+dobHdBg+';padding:12px 16px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid '+dobBdr+';">'
    + '<div style="display:flex;align-items:center;gap:8px;">'
    + '<span style="font-size:1.2rem;">ğŸ‚</span>'
    + '<span style="font-weight:800;font-size:13px;color:#0f172a;">Date of Birth Verification'+(isCollege?' (Optional)':'')+'</span>'
    + '</div>'
    + '<span style="font-size:10px;font-weight:800;padding:3px 10px;border-radius:99px;background:'+dobStatusBg+';color:'+dobStatusC+'">'+dobStatus+'</span>'
    + '</div>'
    // Body
    + '<div style="padding:14px 16px;">'
    + '<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:10px;">'
    // Registered DOB
    + '<div><div style="font-size:10px;font-weight:800;text-transform:uppercase;letter-spacing:.06em;color:#64748b;margin-bottom:4px;">ğŸ“‹ Registered DOB</div>'
    + '<div style="font-size:18px;font-weight:900;color:#0f172a;font-family:monospace;background:#f1f5f9;padding:10px 14px;border-radius:8px;text-align:center;">'+regDobFmt+'</div></div>'
    // Extracted DOB
    + '<div><div style="font-size:10px;font-weight:800;text-transform:uppercase;letter-spacing:.06em;color:#64748b;margin-bottom:4px;">ğŸ” Found on Document</div>'
    + '<div style="font-size:18px;font-weight:900;color:'+(dobRaw?'#0f172a':'#94a3b8')+';font-family:monospace;background:#f1f5f9;padding:10px 14px;border-radius:8px;text-align:center;">'+(dobRaw||'â€”')+'</div></div>'
    + '</div>';

  if(dobMatch){
    html += '<div style="display:flex;align-items:center;gap:8px;font-size:12px;font-weight:700;color:#15803d;"><span>âœ…</span> Date of birth matches perfectly</div>';
  } else if(dobPartial){
    html += '<div style="display:flex;align-items:center;gap:8px;font-size:12px;font-weight:700;color:#92400e;"><span>âš ï¸</span> Only birth year matched â€” full DD/MM/YYYY must be visible</div>';
  } else if(isCollege){
    html += '<div style="display:flex;align-items:center;gap:8px;font-size:12px;font-weight:700;color:#64748b;"><span>â„¹ï¸</span> DOB not found â€” OK for College ID, name match is sufficient</div>';
  } else {
    html += '<div style="display:flex;align-items:center;gap:8px;font-size:12px;font-weight:700;color:#b91c1c;"><span>âŒ</span> DOB not found â€” ensure full date DD/MM/YYYY is clearly visible</div>';
  }
  html += '</div></div>';

  // â”€â”€â”€ Document Details Panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  html += '<div style="background:#f8fafc;border:1px solid #e2e8f0;border-radius:12px;padding:12px 16px;margin-bottom:12px;">'
    + '<div style="font-size:10px;font-weight:800;text-transform:uppercase;letter-spacing:.06em;color:#64748b;margin-bottom:10px;">ğŸ“„ Document Details</div>'
    + '<div style="display:flex;gap:10px;flex-wrap:wrap;">';

  if(aadhaarNum) html += '<div style="background:#eef2ff;border-radius:8px;padding:6px 12px;font-size:12px;font-weight:700;color:#4338ca;">ğŸªª UID: ****'+aadhaarNum.replace(/\s/g,'').slice(-5)+'</div>';
  if(panNum)     html += '<div style="background:#f0fdf4;border-radius:8px;padding:6px 12px;font-size:12px;font-weight:700;color:#15803d;">ğŸ’³ PAN: '+panNum.slice(0,5)+'*****</div>';

  var docLabel2 = docTypeLabels[proofType]||'Document';
  html += '<div style="background:'+(hasAuthMarker?'#f0fdf4':'#fef9c3')+';border-radius:8px;padding:6px 12px;font-size:12px;font-weight:700;color:'+(hasAuthMarker?'#15803d':'#92400e')+'">'
    + (docIcon[proofType]||'ğŸ“„')+' '+(hasAuthMarker?docLabel2+' Detected âœ“':docLabel2+' â€” check photo')+' </div>';

  // OCR confidence chip
  var conf_pct = Math.round(confidence||0);
  html += '<div style="background:#f1f5f9;border-radius:8px;padding:6px 12px;font-size:12px;font-weight:700;color:#64748b;">ğŸ” OCR: '+conf_pct+'%</div>';
  html += '</div></div>';

  // â”€â”€â”€ Failure guidance â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if(!accepted){
    html += '<div class="al '+(scoreTotal>=50?'warn':'err')+'" style="font-size:12px;margin-bottom:6px;">';
    if(isCollege && !nameMatch){
      html += 'âŒ <strong>Name match is '+namePct+'% (need 80%).</strong> Make sure your full name on the College ID matches your registered name exactly. Try better lighting or a clearer photo.';
    } else if(!isCollege && !dobMatch && !dobPartial){
      html += 'âŒ <strong>Date of birth not found.</strong> Ensure the full date (DD/MM/YYYY) is clearly visible on the document. Retake or upload a clearer image.';
    } else if(!isCollege && dobPartial){
      html += 'âš ï¸ <strong>Only birth year matched.</strong> The full date DD/MM/YYYY must be clearly readable. Retake or upload a sharper photo.';
    } else if(!nameMatch){
      html += 'âš ï¸ <strong>Name match is '+namePct+'% (need 80%).</strong> Your registered name "<strong>'+reg.name+'</strong>" must appear clearly on the document. Retake or upload a clearer image.';
    } else {
      html += 'âš ï¸ <strong>Overall score '+scoreTotal+'% (need 80%).</strong> Ensure name and date of birth are both clearly visible. Retake or upload a better photo.';
    }
    html += '</div>';
  }

  document.getElementById('ocrResult').innerHTML = html;
  document.getElementById('btnAccept').style.display = accepted ? 'flex' : 'none';
}

function acceptProof(){
  proofOK = true;
  reg.proofType = proofType;
  stopDocCam();
  goStep(4);
  loadFaceStep();
}

function retryDoc(){
  document.getElementById('s3c').style.display='none';
  document.getElementById('s3b').style.display='block';
  document.getElementById('docLoading').style.display='block';
  document.getElementById('docCamWrap').style.display='none';
  document.getElementById('btnCap').disabled=false;
  document.getElementById('btnCap').innerHTML='ğŸ“¸ Capture';
  document.getElementById('docFrame').className='doc-frame';
  switchTab(isMobile?'cam':'upload');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STEP 4 â€” Face  (FAST: camera first, AI in background)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var autoCountdown=null;  // interval for the 3-2-1 countdown
var capturedCanvas=null; // the snapped canvas, held until AI finishes
var aiReady=false;       // true once face-api models are loaded

async function loadFaceStep(){
  al('e4','','');
  faceCapturing=false; finalDesc=null; faceDescs=[];
  capturedCanvas=null; clearInterval(autoCountdown);

  if(availableCameras.length===0) await detectCameras();
  populateFaceCameraSelect();

  // Auto-pick best camera on desktop
  if(!isMobile && !faceCameraId){
    var best=availableCameras.find(function(c){
      return /integrated|built.?in|hd webcam|hp|laptop/i.test(c.label)&&
             !/virtual|vivo|obs|phone|android|iphone|mirror/i.test(c.label);
    })||availableCameras.find(function(c){
      return !/virtual|vivo|obs|phone|android|iphone|mirror/i.test(c.label);
    });
    if(best) faceCameraId=best.deviceId;
    var sel=document.getElementById('faceCamSelect');
    if(sel&&faceCameraId) sel.value=faceCameraId;
  }

  // â”€â”€ Start camera FIRST (don't wait for AI) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  showFacePanel('cam');
  await openFaceCam();

  // â”€â”€ Start 3-2-1 auto countdown in background â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  startAutoCountdown();

  // â”€â”€ Load AI models in background â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  loadFaceAIBackground();
}

async function openFaceCam(){
  var fallbacks;
  if(faceCameraId){
    fallbacks=[
      {video:{deviceId:{exact:faceCameraId},width:{ideal:1280},height:{ideal:720}}},
      {video:{deviceId:{exact:faceCameraId},width:{ideal:640},height:{ideal:480}}},
      {video:{deviceId:{exact:faceCameraId}}},
    ];
  }else if(isMobile){
    fallbacks=[
      {video:{facingMode:facingMode,width:{ideal:1280},height:{ideal:960}}},
      {video:{facingMode:facingMode,width:{ideal:640},height:{ideal:480}}},
      {video:{facingMode:facingMode}},
    ];
  }else{
    fallbacks=[{video:{width:{ideal:1280},height:{ideal:720}}},{video:{width:{ideal:640},height:{ideal:480}}},{video:true}];
  }

  faceStream=null;
  for(var i=0;i<fallbacks.length;i++){
    try{ faceStream=await navigator.mediaDevices.getUserMedia(fallbacks[i]); break; }
    catch(e){ console.warn('Face cam fallback',i+1,'failed:',e.message); }
  }

  if(!faceStream){
    al('e4','err','âŒ Camera could not start. Close Zoom/Teams, then click Retry Camera below.');
    document.getElementById('btnRetryFace').style.display='block';
    return;
  }

  var v=document.getElementById('faceVid');
  v.srcObject=faceStream; v.play();
  applyFaceFilter();
  startFaceLuxLoop();

  var flipBtn=document.getElementById('btnFlipFace');
  if(flipBtn) flipBtn.style.display=isMobile?'flex':'none';

  // Black-screen auto-fix after 2s
  setTimeout(async function(){
    if(!faceStream) return;
    var v2=document.getElementById('faceVid');
    if(getFaceLum(v2)<6){
      stopFaceCam();
      try{
        var bare=faceCameraId?{video:{deviceId:{exact:faceCameraId}}}:{video:true};
        faceStream=await navigator.mediaDevices.getUserMedia(bare);
        v2.srcObject=faceStream; v2.play(); applyFaceFilter(); startFaceLuxLoop();
      }catch(e){
        al('e4','err','Camera is black. <button onclick="retryFaceCamera()" style="background:#4f46e5;color:white;border:none;border-radius:6px;padding:4px 12px;font-weight:700;cursor:pointer;margin-left:4px;">Retry Camera</button>');
      }
    }
  },2000);
}

// â”€â”€ Lux meter loop (lightweight â€” no AI) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var luxLoop=null;
function startFaceLuxLoop(){
  clearInterval(luxLoop);
  luxLoop=setInterval(function(){
    var v=document.getElementById('faceVid');
    if(!v||!v.videoWidth) return;
    measureFaceLux(v);
  },800);
}

// â”€â”€ Auto countdown: 3 â†’ 2 â†’ 1 â†’ SNAP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function startAutoCountdown(){
  clearInterval(autoCountdown);
  var sec=3;
  // Brief delay so camera has time to show a frame
  setTimeout(function(){
    if(faceCapturing||capturedCanvas) return;
    updateCountdown(sec);
    autoCountdown=setInterval(function(){
      if(faceCapturing||capturedCanvas){clearInterval(autoCountdown);hideCountdown();return;}
      sec--;
      if(sec>0){
        updateCountdown(sec);
      }else{
        clearInterval(autoCountdown);
        hideCountdown();
        snapFace(); // auto-snap!
      }
    },1000);
  },1500);
}

function updateCountdown(n){
  var ov=document.getElementById('cntdOverlay');
  var nm=document.getElementById('cntdNum');
  var ft=document.getElementById('faceTxt');
  if(ov){ ov.style.display='flex'; }
  if(nm){ nm.textContent=n; }
  if(ft){ ft.textContent='Hold still â€” snapping in '+n+'â€¦'; }
  // Flash oval green to signal ready
  var oval=document.getElementById('faceOval');
  if(oval) oval.className='oval rdy';
}

function hideCountdown(){
  var ov=document.getElementById('cntdOverlay');
  if(ov) ov.style.display='none';
}

// â”€â”€ Snap: takes instant photo from video â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function snapFace(){
  if(faceCapturing) return;
  clearInterval(autoCountdown);
  hideCountdown();

  var vid=document.getElementById('faceVid');
  if(!vid||!vid.videoWidth){
    al('e4','err','Camera not ready. Wait a moment or click Retry Camera.');
    return;
  }
  if(getFaceLum(vid)<6){
    al('e4','err','Camera is black. Close other apps using the camera, then Retry Camera.');
    document.getElementById('btnRetryFace').style.display='block';
    return;
  }

  faceCapturing=true;
  document.getElementById('btnFace').disabled=true;
  document.getElementById('faceTxt').textContent='ğŸ“¸ Captured!';
  document.getElementById('faceOval').className='oval rdy';

  // Draw frame to canvas
  var cnv=document.createElement('canvas');
  cnv.width=vid.videoWidth; cnv.height=vid.videoHeight;
  var ctx=cnv.getContext('2d');
  // Mirror-correct for front camera on laptop
  var track=faceStream&&faceStream.getVideoTracks()[0];
  var settings=track?track.getSettings():{};
  var isEnv=settings.facingMode==='environment'||(!isMobile&&facingMode!=='user');
  if(!isMobile&&!isEnv){ ctx.save();ctx.translate(cnv.width,0);ctx.scale(-1,1); }
  // Light boost
  var bri=faceLux<80?2.0:faceLux<130?1.6:1.3;
  ctx.filter='brightness('+bri+') contrast(1.3)';
  ctx.drawImage(vid,0,0);
  if(!isMobile&&!isEnv) ctx.restore();

  capturedCanvas=cnv;

  // Show preview immediately
  var dispCnv=document.getElementById('faceCanvas');
  dispCnv.width=cnv.width; dispCnv.height=cnv.height;
  dispCnv.getContext('2d').drawImage(cnv,0,0);

  stopFaceCam();
  clearInterval(luxLoop);

  // Switch to "processing" panel, run AI on captured frame
  showFacePanel('proc');
  setProc('Analysing faceâ€¦', 20);
  await computeDescriptor(cnv);
}

// â”€â”€ AI descriptor computation (runs after snap) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function computeDescriptor(cnv){
  // If AI not loaded yet, wait for it (up to 15s more)
  if(!aiReady||typeof faceapi==='undefined'){
    setProc('Waiting for AI to finish loadingâ€¦', 35);
    for(var wi=0;wi<30;wi++){
      if(aiReady&&typeof faceapi!=='undefined') break;
      await new Promise(function(r){setTimeout(r,500);});
    }
  }

  if(!aiReady||typeof faceapi==='undefined'){
    // AI never loaded â€” use pixel fingerprint fallback
    setProc('AI unavailable â€” using photo fingerprintâ€¦', 80);
    finalDesc=pixelFP(cnv);
    await new Promise(function(r){setTimeout(r,600);});
    setProc('Done!', 100);
    await new Promise(function(r){setTimeout(r,300);});
    showFacePanel('prev');
    faceCapturing=false;
    return;
  }

  try{
    setProc('Detecting faceâ€¦', 50);
    // Try all quality levels for robustness
    var det=null;
    var opts=[
      window._tiny?new faceapi.TinyFaceDetectorOptions({inputSize:320,scoreThreshold:0.18}):new faceapi.SsdMobilenetv1Options({minConfidence:0.18}),
      window._tiny?new faceapi.TinyFaceDetectorOptions({inputSize:224,scoreThreshold:0.10}):new faceapi.SsdMobilenetv1Options({minConfidence:0.10}),
      window._tiny?new faceapi.TinyFaceDetectorOptions({inputSize:160,scoreThreshold:0.05}):new faceapi.SsdMobilenetv1Options({minConfidence:0.05}),
    ];
    for(var qi=0;qi<opts.length&&!det;qi++){
      try{
        var tmo=new Promise(function(_,rej){setTimeout(function(){rej(new Error('timeout'));},3000);});
        det=await Promise.race([
          faceapi.detectSingleFace(cnv,opts[qi]).withFaceLandmarks().withFaceDescriptor(),
          tmo
        ]);
      }catch(e){ /* try next */ }
    }

    setProc('Computing face dataâ€¦', 80);

    if(det&&det.descriptor){
      finalDesc=det.descriptor;
      if(isBlackDescriptor(finalDesc)){
        // Fallback to pixel FP
        finalDesc=pixelFP(cnv);
        al('e4','warn','âš ï¸ Face data quality low â€” proceed or retake for better accuracy.');
      }
    } else {
      // Face not detected â€” still proceed with pixel FP so user isn't blocked
      finalDesc=pixelFP(cnv);
      al('e4','warn','âš ï¸ Face AI could not detect face features â€” photo saved. Proceed or retake.');
    }

    setProc('Done!', 100);
    await new Promise(function(r){setTimeout(r,300);});
    showFacePanel('prev');
    faceCapturing=false;

  }catch(err){
    console.error('Descriptor error:', err);
    finalDesc=pixelFP(cnv);
    setProc('Done (fallback)!', 100);
    await new Promise(function(r){setTimeout(r,300);});
    showFacePanel('prev');
    faceCapturing=false;
  }
}

// â”€â”€ AI background loader â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadFaceAIBackground(){
  if(aiReady) return;
  var statusTxt=document.getElementById('aiStatusTxt');
  var spinner=document.getElementById('aiSpinner');
  function setStatus(t){ if(statusTxt) statusTxt.textContent=t; }

  // Load script
  if(typeof faceapi==='undefined'){
    setStatus('Loading face AI (1/4)â€¦');
    try{
      await loadScript('https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js');
    }catch(e){
      setStatus('âš ï¸ AI load failed â€” photo-only mode');
      if(spinner) spinner.style.display='none';
      return;
    }
  }

  var cdns=[CDN1,CDN2];
  for(var ci=0;ci<cdns.length;ci++){
    try{
      setStatus('Loading detector (2/4)â€¦');
      await faceapi.nets.tinyFaceDetector.loadFromUri(cdns[ci]);
      setStatus('Loading landmarks (3/4)â€¦');
      await faceapi.nets.faceLandmark68TinyNet.loadFromUri(cdns[ci]);
      setStatus('Loading recognition (4/4)â€¦');
      await faceapi.nets.faceRecognitionNet.loadFromUri(cdns[ci]);
      aiReady=true; window._tiny=true;
      setStatus('âœ… Face AI ready');
      if(spinner){ spinner.style.display='none'; }
      // If we already captured, run descriptor now
      if(capturedCanvas&&faceCapturing===false&&finalDesc&&isBlackDescriptor(finalDesc)){
        setStatus('Improving accuracyâ€¦');
        await computeDescriptor(capturedCanvas);
      }
      return;
    }catch(e){ console.warn('AI CDN',ci,'failed:',e.message); setStatus('Trying backup serverâ€¦'); }
  }

  // Try SSD fallback
  for(var ci2=0;ci2<cdns.length;ci2++){
    try{
      setStatus('Loading detector (2/4)â€¦');
      await faceapi.nets.ssdMobilenetv1.loadFromUri(cdns[ci2]);
      setStatus('Loading landmarks (3/4)â€¦');
      await faceapi.nets.faceLandmark68Net.loadFromUri(cdns[ci2]);
      setStatus('Loading recognition (4/4)â€¦');
      await faceapi.nets.faceRecognitionNet.loadFromUri(cdns[ci2]);
      aiReady=true;
      setStatus('âœ… Face AI ready');
      if(spinner){ spinner.style.display='none'; }
      return;
    }catch(e2){ console.warn('SSD CDN',ci2,'failed:',e2.message); }
  }
  setStatus('âš ï¸ AI unavailable â€” photo-only mode active');
  if(spinner){ spinner.style.display='none'; }
}

// â”€â”€ Pixel fingerprint fallback â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function isBlackDescriptor(desc){
  if(!desc||desc.length!==128) return true;
  var mn=desc[0],mx=desc[0];
  for(var i=1;i<128;i++){if(desc[i]<mn)mn=desc[i];if(desc[i]>mx)mx=desc[i];}
  var sum=0; for(var j=0;j<128;j++) sum+=desc[j];
  return (mx-mn)<0.008||(sum/128)<0.001;
}

function pixelFP(src){
  var c=document.createElement('canvas'); c.width=16; c.height=16;
  c.getContext('2d').drawImage(src,0,0,16,16);
  var px=c.getContext('2d').getImageData(0,0,16,16).data;
  var desc=new Float32Array(128);
  for(var i=0;i<128;i++){
    var b=i*2; desc[i]=(px[b*4]+px[b*4+1]+px[b*4+2])/765;
  }
  return desc;
}

// â”€â”€ Utilities â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setProc(t,p){
  var el=document.getElementById('procTxt'); if(el) el.textContent=t;
  var bar=document.getElementById('procBar'); if(bar) bar.style.width=p+'%';
}

function showFacePanel(p){
  // s4a removed â€” go direct cam â†’ proc â†’ prev
  var cam=document.getElementById('s4b');
  var proc=document.getElementById('s4proc');
  var prev=document.getElementById('s4c');
  if(cam)  cam.style.display  = p==='cam'  ? 'block':'none';
  if(proc) proc.style.display = p==='proc' ? 'block':'none';
  if(prev) prev.style.display = p==='prev' ? 'block':'none';
}

function populateFaceCameraSelect(){
  var wrap=document.getElementById('faceCamSelectWrap');
  var sel=document.getElementById('faceCamSelect');
  if(!wrap||availableCameras.length<=1){if(wrap)wrap.style.display='none';return;}
  sel.innerHTML='';
  availableCameras.forEach(function(cam){
    var opt=document.createElement('option');
    opt.value=cam.deviceId;
    var isVirtual=/virtual|vivo|obs|snap|phone|android|iphone|mirror/i.test(cam.label);
    var isBuiltIn=/integrated|built.?in|hd webcam|hp|laptop/i.test(cam.label);
    opt.textContent=(isVirtual?'[Virtual] ':isBuiltIn?'[Webcam] ':'[Camera] ')+(cam.label||'Camera');
    if(isBuiltIn&&!isVirtual) opt.selected=true;
    sel.appendChild(opt);
  });
  if(faceCameraId) sel.value=faceCameraId;
  wrap.style.display='block';
}

function applyFaceFilter(){
  var v=document.getElementById('faceVid');
  if(v) v.style.filter=faceBoostOn?'brightness(2.2) contrast(1.6)':'brightness(1.5) contrast(1.2)';
}
function flipFaceCam(){clearInterval(autoCountdown);stopFaceCam();facingMode=facingMode==='user'?'environment':'user';loadFaceStep();}
function toggleFaceBoost(){faceBoostOn=!faceBoostOn;document.getElementById('faceBoost').classList.toggle('on',faceBoostOn);applyFaceFilter();}
async function switchFaceCamera(){faceCameraId=document.getElementById('faceCamSelect').value;clearInterval(autoCountdown);stopFaceCam();await loadFaceStep();}
async function retryFaceCamera(){faceCameraId=null;clearInterval(autoCountdown);stopFaceCam();await loadFaceStep();}

function retakeFace(){
  finalDesc=null; faceDescs=[]; faceCapturing=false; capturedCanvas=null;
  clearInterval(autoCountdown); clearInterval(luxLoop);
  document.getElementById('faceOval').className='oval';
  document.getElementById('btnFace').disabled=false;
  document.getElementById('btnRetryFace').style.display='none';
  al('e4','','');
  loadFaceStep();
}

function stopFaceCam(){
  clearInterval(luxLoop); clearInterval(autoCountdown);
  if(faceStream){faceStream.getTracks().forEach(function(t){t.stop();});faceStream=null;}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STEP 5 â€” Register
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function doRegister(){
  var btn=document.getElementById('btnReg');
  btn.disabled=true;btn.innerHTML='<span class="spin"></span> Registeringâ€¦';
  try{
    var res=await fetch('/api/voter/register',{
      method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({
        name:reg.name,dob:reg.dob,phone:reg.phone,address:reg.address,
        proofType:reg.proofType||proofType,proofVerified:proofOK,
        faceDescriptor:Array.from(finalDesc)
      })
    });
    var data=await res.json();
    if(res.status===409&&data.error==='DUPLICATE_VOTER'){stopFaceCam();goStep(5);showDup(data);return;}
    if(!res.ok) throw new Error(data.error||'Registration failed.');
    stopFaceCam();goStep(5);showDone(data);
  }catch(e){
    document.getElementById('s4c').insertAdjacentHTML('afterbegin','<div class="al err" style="margin-bottom:10px;">âŒ '+e.message+'</div>');
    btn.disabled=false;btn.innerHTML='âœ… Complete Registration';
  }
}

function showDone(data){
  document.getElementById('s5content').innerHTML=
    '<div class="card" style="text-align:center;padding:28px 20px;">'+
    '<div style="font-size:3rem;margin-bottom:12px;">ğŸ‰</div>'+
    '<h2 style="margin-bottom:6px;">Registered Successfully!</h2>'+
    '<p style="color:#64748b;font-size:13px;margin-bottom:20px;">Save your Voter ID â€” you need it to login and vote.</p>'+
    '<div class="vid-card"><div style="font-size:10px;opacity:.6;text-transform:uppercase;letter-spacing:.08em;">ğŸ—³ï¸ Voter ID</div>'+
    '<div class="vid-num">'+data.voterId+'</div>'+
    '<div style="font-weight:700;">'+data.name+'</div>'+
    '<div style="font-size:11px;opacity:.5;margin-top:8px;">ğŸ“¸ Screenshot this now!</div></div>'+
    '<div class="al warn" style="text-align:left;margin:14px 0;font-size:12px;">âš ï¸ <strong>Screenshot your Voter ID now.</strong> It cannot be recovered if lost.</div>'+
    '<a href="/voter-login" class="btn blue" style="max-width:300px;margin:0 auto;display:flex;">Login to Vote â†’</a></div>';
}

function showDup(data){
  var reasons={phone:'This phone number is already registered.',name_dob:'Same name and date of birth already registered.',face:'Our AI detected your face is already registered.'};
  document.getElementById('s5content').innerHTML=
    '<div class="card" style="text-align:center;padding:24px 20px;">'+
    '<div style="width:68px;height:68px;background:#fee2e2;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:2rem;margin:0 auto 14px;">ğŸš«</div>'+
    '<h2 style="color:#b91c1c;margin-bottom:6px;">Already Registered!</h2>'+
    '<p style="color:#64748b;font-size:13px;margin-bottom:14px;">You are an existing voter.</p>'+
    '<div style="background:#fef2f2;border:2px solid #fecaca;border-radius:14px;padding:14px;margin-bottom:14px;text-align:left;">'+
    '<p style="font-size:13px;color:#7f1d1d;margin-bottom:12px;">âš ï¸ '+(reasons[data.type]||data.message)+'</p>'+
    '<div style="display:flex;align-items:center;gap:10px;border-top:1px solid #fecaca;padding-top:12px;">'+
    '<div style="width:40px;height:40px;background:#fee2e2;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1.3rem;flex-shrink:0;">ğŸ§‘â€ğŸ’¼</div>'+
    '<div><div style="font-weight:800;">'+data.existingName+'</div>'+
    '<div style="font-family:monospace;font-size:15px;color:#4f46e5;font-weight:900;">'+data.existingVoterId+'</div></div></div></div>'+
    '<div class="al ok" style="text-align:left;font-size:13px;margin-bottom:14px;">âœ… Use Voter ID <strong style="font-family:monospace;">'+data.existingVoterId+'</strong> to login and vote.</div>'+
    '<a href="/voter-login" class="btn blue" style="display:flex;margin-bottom:8px;">ğŸ—³ï¸ Go to Voter Login</a>'+
    '<a href="/" style="font-size:13px;color:#94a3b8;display:block;margin-top:6px;">â† Home</a></div>';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UTILITIES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function avgDescs(descs){
  var out=new Float32Array(128);
  for(var d=0;d<descs.length;d++) for(var i=0;i<128;i++) out[i]+=descs[d][i];
  for(var i=0;i<128;i++) out[i]/=descs.length;
  return out;
}
function getFaceLum(vid){
  try{
    var c=document.createElement('canvas');c.width=32;c.height=24;
    c.getContext('2d').drawImage(vid,0,0,32,24);
    var px=c.getContext('2d').getImageData(0,0,32,24).data,s=0;
    for(var i=0;i<px.length;i+=4) s+=(px[i]+px[i+1]+px[i+2])/3;
    return s/(px.length/4);
  }catch(e){return 128;}
}
function enhanceFrame(vid){
  var c=document.createElement('canvas');c.width=vid.videoWidth||640;c.height=vid.videoHeight||480;
  var ctx=c.getContext('2d');
  var b=faceLux<80?2.0:faceLux<130?1.6:1.3, con=faceLux<80?1.6:1.3;
  ctx.filter='brightness('+b+') contrast('+con+')';ctx.drawImage(vid,0,0);return c;
}
function measureFaceLux(vid){
  try{
    var c=document.createElement('canvas');c.width=80;c.height=60;
    var ctx=c.getContext('2d');ctx.drawImage(vid,0,0,80,60);
    var px=ctx.getImageData(0,0,80,60).data,s=0;
    for(var i=0;i<px.length;i+=16)s+=(px[i]+px[i+1]+px[i+2])/3;
    faceLux=s/(px.length/16);
    var chip=document.getElementById('faceLx');if(!chip)return;
    if(faceLux<50){chip.textContent='ğŸŒ‘ Very Dark';chip.style.background='rgba(120,53,15,.85)';if(!faceBoostOn){faceBoostOn=true;applyFaceFilter();document.getElementById('faceBoost').classList.add('on');}}
    else if(faceLux<90){chip.textContent='ğŸŒ™ Low';chip.style.background='rgba(100,50,0,.85)';}
    else if(faceLux<160){chip.textContent='ğŸ’¡ OK';chip.style.background='rgba(0,0,0,.6)';}
    else{chip.textContent='â˜€ï¸ Good';chip.style.background='rgba(5,80,40,.85)';}
  }catch(e){}
}
function loadScript(src){
  return new Promise(function(res,rej){
    var s=document.createElement('script');s.src=src;s.onload=res;s.onerror=rej;document.head.appendChild(s);
  });
}

// â”€â”€ INIT â€” safe, runs after DOM ready â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.addEventListener('DOMContentLoaded', function(){
  try { buildOtp(); } catch(e){ console.error('buildOtp error:', e); }
  goStep(1);
});
// Fallback if DOMContentLoaded already fired
if(document.readyState !== 'loading'){
  try { buildOtp(); } catch(e){ console.error('buildOtp error:', e); }
  goStep(1);
}
</script>
</body>
</html>
