<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no"/>
  <title>Voter Registration â€” VoteSecure</title>
  <link rel="stylesheet" href="/css/style.css"/>
  <style>
    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
    body{background:#0f172a;min-height:100vh;}
    .page{max-width:520px;margin:0 auto;padding:14px 14px 60px;}

    /* Steps */
    .steps{display:flex;background:rgba(255,255,255,.07);border-radius:12px;padding:4px;margin-bottom:14px;}
    .sp{flex:1;padding:8px 2px;text-align:center;border-radius:9px;font-size:10px;font-weight:700;color:rgba(255,255,255,.3);transition:all .25s;white-space:nowrap;}
    .sp.active{background:white;color:#4f46e5;}
    .sp.done{color:rgba(255,255,255,.55);}

    /* Card */
    .card{background:white;border-radius:20px;padding:22px;margin-bottom:12px;}
    .ctitle{font-size:1.1rem;font-weight:800;margin:0 0 3px;}
    .csub{color:#64748b;font-size:13px;margin:0 0 18px;}

    /* Form */
    .lbl{font-size:11px;font-weight:800;text-transform:uppercase;letter-spacing:.06em;color:#64748b;display:block;margin-bottom:5px;}
    .inp{width:100%;padding:12px 14px;border:2px solid #e2e8f0;border-radius:10px;font-size:15px;outline:none;transition:border-color .2s;background:white;}
    .inp:focus{border-color:#4f46e5;box-shadow:0 0 0 3px rgba(79,70,229,.1);}
    .fg{margin-bottom:14px;}

    /* Buttons */
    .btn{width:100%;height:52px;border-radius:14px;border:none;font-size:15px;font-weight:700;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;touch-action:manipulation;text-decoration:none;transition:all .15s;}
    .btn.blue {background:#4f46e5;color:white;}
    .btn.blue:hover:not(:disabled){background:#3730a3;}
    .btn.blue:disabled{background:#a5b4fc;cursor:not-allowed;}
    .btn.green{background:#059669;color:white;}
    .btn.grey {background:#f1f5f9;color:#0f172a;font-size:14px;}
    .btn-row  {display:flex;gap:10px;margin-top:8px;}

    /* Alerts */
    .al{padding:11px 14px;border-radius:10px;font-size:13px;font-weight:600;margin-bottom:10px;}
    .al.err {background:#fee2e2;color:#b91c1c;border:1px solid #fecaca;}
    .al.ok  {background:#dcfce7;color:#15803d;border:1px solid #bbf7d0;}
    .al.warn{background:#fef3c7;color:#a16207;border:1px solid #fde68a;}
    .al.info{background:#e0e7ff;color:#4338ca;border:1px solid #c7d2fe;}

    /* OTP boxes */
    .otp-row{display:flex;gap:8px;justify-content:center;margin:14px 0;}
    .otp-d{width:46px;height:54px;border:2px solid #e2e8f0;border-radius:10px;font-size:1.4rem;font-weight:900;text-align:center;outline:none;transition:all .2s;}
    .otp-d:focus{border-color:#4f46e5;box-shadow:0 0 0 3px rgba(79,70,229,.12);}
    .otp-d.ok{border-color:#10b981;background:#f0fdf4;}

    /* Proof type cards */
    .proof-row{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:14px;}
    .pcard{border:2px solid #e2e8f0;border-radius:14px;padding:16px 10px;text-align:center;cursor:pointer;transition:all .2s;user-select:none;}
    .pcard:hover{border-color:#a5b4fc;background:#f5f3ff;}
    .pcard.sel{border-color:#4f46e5;background:#eef2ff;box-shadow:0 0 0 3px rgba(79,70,229,.1);}
    .pcard .icon{font-size:2.2rem;margin-bottom:8px;}
    .pcard .pname{font-weight:800;font-size:13px;}
    .pcard .pdesc{font-size:11px;color:#64748b;margin-top:3px;}

    /* Document camera */
    .doc-cam{position:relative;background:#000;border-radius:16px;overflow:hidden;width:100%;aspect-ratio:16/10;margin-bottom:8px;}
    .doc-cam video{width:100%;height:100%;object-fit:cover;display:block;}
    .doc-frame{position:absolute;top:8%;left:5%;right:5%;bottom:8%;border:3px dashed rgba(255,255,255,.7);border-radius:10px;pointer-events:none;transition:all .3s;}
    .doc-frame.scan{border-color:#f59e0b;border-style:solid;animation:blink .8s infinite;}
    .doc-frame.good{border-color:#10b981;border-style:solid;}
    .doc-corner{position:absolute;width:20px;height:20px;border-color:#10b981;border-style:solid;}
    .doc-corner.tl{top:8%;left:5%;border-width:3px 0 0 3px;border-radius:4px 0 0 0;}
    .doc-corner.tr{top:8%;right:5%;border-width:3px 3px 0 0;border-radius:0 4px 0 0;}
    .doc-corner.bl{bottom:8%;left:5%;border-width:0 0 3px 3px;border-radius:0 0 0 4px;}
    .doc-corner.br{bottom:8%;right:5%;border-width:0 3px 3px 0;border-radius:0 0 4px 0;}
    @keyframes blink{0%,100%{opacity:1;}50%{opacity:.3;}}
    .cam-bar{position:absolute;bottom:0;left:0;right:0;background:rgba(0,0,0,.82);color:white;padding:8px 12px;text-align:center;font-size:12px;font-weight:600;}
    .cam-top{position:absolute;top:0;left:0;right:0;padding:8px 12px;display:flex;justify-content:space-between;align-items:center;background:linear-gradient(to bottom,rgba(0,0,0,.72),transparent);}
    .lx{padding:3px 9px;border-radius:99px;font-size:10px;font-weight:700;color:white;background:rgba(0,0,0,.5);}
    .icn{width:32px;height:32px;background:rgba(255,255,255,.15);border:none;border-radius:50%;color:white;font-size:14px;cursor:pointer;display:flex;align-items:center;justify-content:center;}
    .icn.on{background:rgba(79,70,229,.75);}

    /* Face camera */
    .face-cam{position:relative;background:#000;border-radius:18px;overflow:hidden;width:100%;aspect-ratio:3/4;max-height:360px;}
    .face-cam video{width:100%;height:100%;object-fit:cover;display:block;}
    .oval-wrap{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;pointer-events:none;}
    .oval{width:54%;height:74%;border-radius:50%;border:3px solid rgba(255,255,255,.5);box-shadow:0 0 0 9999px rgba(0,0,0,.46);transition:all .25s;}
    .oval.rdy{border-color:#10b981;box-shadow:0 0 0 9999px rgba(0,0,0,.4),0 0 20px rgba(16,185,129,.5);}
    .oval.bad{border-color:#ef4444;}
    .face-btm{position:absolute;bottom:0;left:0;right:0;padding:11px;background:linear-gradient(to top,rgba(0,0,0,.8),transparent);}
    .face-txt{color:white;font-size:12px;font-weight:600;text-align:center;margin-bottom:7px;}
    .dots{display:flex;gap:8px;justify-content:center;}
    .dot{width:11px;height:11px;border-radius:50%;background:rgba(255,255,255,.3);transition:all .3s;}
    .dot.f{background:#10b981;transform:scale(1.2);}
    .dot.a{background:#f59e0b;animation:pd .6s infinite;}
    @keyframes pd{0%,100%{transform:scale(1);}50%{transform:scale(1.3);}}

    /* Progress */
    .prog{background:#f1f5f9;border-radius:99px;height:5px;overflow:hidden;max-width:260px;margin:8px auto 0;}
    .prog-f{height:100%;background:#4f46e5;border-radius:99px;transition:width .4s;}

    /* Spinners */
    @keyframes spin{to{transform:rotate(360deg);}}
    .spin  {width:17px;height:17px;border:2px solid rgba(255,255,255,.3);border-top-color:white;border-radius:50%;animation:spin .6s linear infinite;flex-shrink:0;}
    .spin-b{width:15px;height:15px;border:2px solid rgba(79,70,229,.2);border-top-color:#4f46e5;border-radius:50%;animation:spin .6s linear infinite;}

    /* Voter ID card */
    .vid-card{background:linear-gradient(135deg,#1e1b4b,#4338ca);border-radius:18px;padding:26px;color:white;text-align:center;max-width:300px;margin:0 auto 16px;}
    .vid-num {font-size:1.8rem;font-weight:900;letter-spacing:.13em;font-family:monospace;margin:8px 0;}

    /* Preview */
    .prev{position:relative;border-radius:14px;overflow:hidden;margin-bottom:10px;}
    .prev canvas{width:100%;display:block;}
    .prev-badge{position:absolute;top:10px;right:10px;background:rgba(16,185,129,.9);color:white;border-radius:8px;padding:4px 10px;font-size:11px;font-weight:700;}

    /* OCR */
    .ocr-box{border-radius:12px;padding:14px;margin:10px 0;}
    .ocr-box.ok  {background:#dcfce7;border:2px solid #10b981;}
    .ocr-box.fail{background:#fee2e2;border:2px solid #ef4444;}
    .ocr-box.warn{background:#fef3c7;border:2px solid #f59e0b;}
    .ocr-row{display:flex;align-items:center;gap:8px;margin-bottom:7px;}
    .ocr-row:last-child{margin:0;}
    .ocr-k{font-size:11px;font-weight:800;text-transform:uppercase;color:#64748b;min-width:55px;flex-shrink:0;}
    .ocr-v{font-size:14px;font-weight:800;color:#0f172a;flex:1;word-break:break-all;}
    .tag  {font-size:10px;font-weight:700;padding:2px 8px;border-radius:99px;white-space:nowrap;}
    .tag.ok  {background:#dcfce7;color:#15803d;}
    .tag.fail{background:#fee2e2;color:#b91c1c;}
    .tag.warn{background:#fef3c7;color:#92400e;}

    /* Confidence meter */
    .conf-bar{height:4px;background:#e2e8f0;border-radius:99px;margin-top:10px;overflow:hidden;}
    .conf-fill{height:100%;border-radius:99px;transition:width .5s;}

    @media(max-width:400px){.proof-row{grid-template-columns:1fr;}.otp-d{width:38px;height:48px;font-size:1.2rem;}}
  </style>
</head>
<body>
<nav style="background:rgba(255,255,255,.05);backdrop-filter:blur(12px);border-bottom:1px solid rgba(255,255,255,.1);padding:0 18px;height:56px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:100;">
  <a href="/" style="color:white;font-weight:800;font-size:1.05rem;text-decoration:none;">ğŸ—³ï¸ VoteSecure</a>
  <a href="/voter-login" style="color:rgba(255,255,255,.6);font-size:12px;text-decoration:none;">Already registered? â†’</a>
</nav>

<div class="page">
  <div class="steps" style="margin-top:14px;">
    <div class="sp" id="sp1">1Â·Info</div>
    <div class="sp" id="sp2">2Â·OTP</div>
    <div class="sp" id="sp3">3Â·ID Proof</div>
    <div class="sp" id="sp4">4Â·Face</div>
    <div class="sp" id="sp5">5Â·Done</div>
  </div>

  <!-- â”€â”€â”€ STEP 1: Info â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div id="step1" style="display:none;">
    <div class="card">
      <p class="ctitle">ğŸ“‹ Personal Information</p>
      <p class="csub">Enter details exactly as on your ID document</p>
      <div id="e1"></div>
      <div class="fg">
        <label class="lbl">Full Name *</label>
        <input id="fName" class="inp" type="text" placeholder="As on Aadhaar / College ID" autocomplete="name"/>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
        <div class="fg">
          <label class="lbl">Date of Birth *</label>
          <input id="fDob" class="inp" type="date"/>
        </div>
        <div class="fg">
          <label class="lbl">Phone Number *</label>
          <input id="fPhone" class="inp" type="tel" placeholder="10-digit mobile" inputmode="tel" autocomplete="tel"/>
        </div>
      </div>
      <div class="fg" style="margin-bottom:18px;">
        <label class="lbl">Address</label>
        <textarea id="fAddr" class="inp" rows="2" placeholder="Residential address" style="resize:none;"></textarea>
      </div>
      <button class="btn blue" onclick="s1Next()">Continue â†’ OTP Verification</button>
    </div>
  </div>

  <!-- â”€â”€â”€ STEP 2: OTP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div id="step2" style="display:none;">
    <div class="card">
      <p class="ctitle">ğŸ“± Phone Verification</p>
      <p class="csub">Verify your mobile number with a 6-digit OTP</p>
      <div id="e2"></div>
      <div class="al info" style="font-size:12px;margin-bottom:12px;">â„¹ï¸ <strong>Demo Mode:</strong> OTP shown on screen. In production it is sent via SMS.</div>

      <div id="otpSend">
        <div style="background:#f8fafc;border-radius:12px;padding:14px;margin-bottom:14px;display:flex;align-items:center;gap:12px;">
          <span style="font-size:1.8rem;">ğŸ“±</span>
          <div>
            <div style="font-size:11px;color:#64748b;font-weight:700;text-transform:uppercase;">Sending OTP to</div>
            <div id="phoneDisp" style="font-weight:800;font-size:1rem;font-family:monospace;color:#0f172a;"></div>
          </div>
        </div>
        <button class="btn blue" id="btnSend" onclick="sendOtp()">ğŸ“¤ Send OTP</button>
      </div>

      <div id="otpEntry" style="display:none;">
        <p style="text-align:center;font-size:13px;color:#64748b;margin-bottom:2px;">Enter the 6-digit OTP</p>
        <div id="otpHint" style="display:none;text-align:center;background:#fef3c7;border-radius:8px;padding:7px 14px;font-size:14px;font-weight:800;color:#92400e;margin-bottom:4px;"></div>
        <div class="otp-row" id="otpRow"></div>
        <p id="otpTimer" style="text-align:center;font-size:12px;color:#64748b;margin-bottom:12px;"></p>
        <button class="btn blue" id="btnVerify" onclick="verifyOtp()" disabled>âœ… Verify OTP</button>
        <button class="btn grey" onclick="resetOtp()" style="margin-top:8px;">ğŸ”„ Resend OTP</button>
      </div>

      <button class="btn grey" onclick="goStep(1)" style="margin-top:8px;">â† Back</button>
    </div>
  </div>

  <!-- â”€â”€â”€ STEP 3: ID Proof â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div id="step3" style="display:none;">

    <!-- 3a: Choose type -->
    <div id="s3a" class="card">
      <p class="ctitle">ğŸªª Identity & Age Proof</p>
      <p class="csub">Scan your ID â€” OCR reads name &amp; DOB automatically</p>
      <div id="e3a"></div>
      <div class="proof-row">
        <div class="pcard" id="pc-a" onclick="pickProof('aadhaar')">
          <div class="icon">ğŸªª</div>
          <div class="pname">Aadhaar Card</div>
          <div class="pdesc">Government issued<br/>âœ… Recommended</div>
        </div>
        <div class="pcard" id="pc-c" onclick="pickProof('college')">
          <div class="icon">ğŸ“</div>
          <div class="pname">College ID</div>
          <div class="pdesc">Student ID with<br/>Name &amp; DOB</div>
        </div>
      </div>
      <div id="proofTip" style="display:none;margin-bottom:14px;"></div>
      <button class="btn blue" id="btnGoScan" onclick="startScan()" disabled>Continue â†’ Scan Document</button>
      <button class="btn grey" onclick="goStep(2)" style="margin-top:8px;">â† Back</button>
    </div>

    <!-- 3b: Camera -->
    <div id="s3b" style="display:none;">
      <div class="card">
        <p class="ctitle" id="scanTitle">ğŸ“· Scan Document</p>
        <p class="csub" id="scanSub">Loading cameraâ€¦</p>
        <div id="e3b"></div>

        <!-- Device banner (filled by JS) -->
        <div id="deviceTip" style="display:none;margin-bottom:12px;"></div>

        <!-- Camera selector â€” shown when multiple cameras detected -->
        <div id="camSelectWrap" style="display:none;margin-bottom:12px;">
          <label class="lbl">Select Camera</label>
          <select id="camSelect" class="inp" style="height:44px;padding:8px 12px;" onchange="switchCamera()"></select>
        </div>

        <div id="docLoading" style="text-align:center;padding:20px 0;">
          <div class="spin-b" style="margin:0 auto 10px;"></div>
          <p id="docLoadTxt" style="font-size:13px;color:#64748b;font-weight:600;">Starting cameraâ€¦</p>
        </div>

        <div id="docCamWrap" style="display:none;">
          <div class="doc-cam" id="docCamBox">
            <video id="docVid" autoplay muted playsinline></video>
            <div class="cam-top">
              <span class="lx" id="docLx">ğŸ’¡â€”</span>
              <div style="display:flex;gap:7px;">
                <button class="icn" id="btnFlipDoc" onclick="flipDocCam()" style="display:none;" title="Flip camera">ğŸ”„</button>
                <button class="icn" id="docBoost" onclick="toggleDocBoost()" title="Boost brightness">â˜€ï¸</button>
              </div>
            </div>
            <div class="doc-frame" id="docFrame"></div>
            <div class="doc-corner tl"></div><div class="doc-corner tr"></div>
            <div class="doc-corner bl"></div><div class="doc-corner br"></div>
            <div class="cam-bar" id="docBar">ğŸ“„ Hold document inside the frame</div>
          </div>
          <p id="docHint" style="text-align:center;font-size:11px;color:rgba(255,255,255,.4);margin:6px 0 10px;"></p>
          <div id="docTipBox" style="margin-bottom:10px;"></div>
          <div class="btn-row">
            <button class="btn grey" style="max-width:70px;" onclick="stopDocCam();showS3a()">â† Back</button>
            <button class="btn blue" id="btnCap" onclick="captureDoc()">ğŸ“¸ Capture</button>
          </div>
        </div>
      </div>
    </div>

    <!-- 3c: OCR result -->
    <div id="s3c" style="display:none;">
      <div class="card">
        <p class="ctitle">ğŸ” Verifying Document</p>
        <div id="e3c"></div>
        <canvas id="docCanvas" style="width:100%;border-radius:12px;display:block;margin-bottom:12px;"></canvas>
        <div id="ocrLoading" style="text-align:center;padding:12px 0;">
          <div style="display:flex;align-items:center;justify-content:center;gap:10px;margin-bottom:8px;">
            <div class="spin-b"></div>
            <span id="ocrTxt" style="font-size:13px;font-weight:700;color:#4f46e5;">Preprocessing imageâ€¦</span>
          </div>
          <div class="prog" style="max-width:200px;"><div class="prog-f" id="ocrBar" style="width:5%;"></div></div>
        </div>
        <div id="ocrResult" style="display:none;"></div>
        <div id="ocrActions" style="display:none;margin-top:12px;">
          <button class="btn green" id="btnAccept" onclick="acceptProof()" style="display:none;">âœ… Verified â€” Continue to Face Scan</button>
          <button class="btn grey" onclick="retryDoc()" style="margin-top:8px;">ğŸ”„ Retake Photo</button>
        </div>
      </div>
    </div>
  </div>

  <!-- â”€â”€â”€ STEP 4: Face â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div id="step4" style="display:none;">

    <!-- 4a: Loading -->
    <div id="s4a" class="card" style="text-align:center;padding:30px 20px;">
      <div style="font-size:3rem;margin-bottom:12px;">ğŸ¤–</div>
      <p id="aiTxt" style="font-weight:700;font-size:14px;margin-bottom:10px;">Loading AIâ€¦</p>
      <div class="prog"><div class="prog-f" id="aiBar" style="width:5%;"></div></div>
    </div>

    <!-- 4b: Camera -->
    <div id="s4b" style="display:none;">
      <div class="face-cam" id="faceCamEl">
        <video id="faceVid" autoplay muted playsinline></video>
        <div class="cam-top">
          <span class="lx" id="faceLx">ğŸ’¡â€”</span>
          <div style="display:flex;gap:7px;">
            <button class="icn" onclick="flipFaceCam()">ğŸ”„</button>
            <button class="icn" id="faceBoost" onclick="toggleFaceBoost()">â˜€ï¸</button>
          </div>
        </div>
        <div class="oval-wrap"><div class="oval" id="faceOval"></div></div>
        <div class="face-btm">
          <div class="face-txt" id="faceTxt">ğŸ‘¤ Align face inside the oval</div>
          <div class="dots" id="faceDots" style="display:none;">
            <div class="dot" id="d0"></div><div class="dot" id="d1"></div><div class="dot" id="d2"></div>
          </div>
        </div>
      </div>
      <p style="text-align:center;font-size:11px;color:rgba(255,255,255,.4);margin:6px 0 10px;">ğŸ”„ flip Â· â˜€ï¸ boost Â· Hold still for 3-frame capture</p>
      <div id="e4"></div>
      <div class="btn-row">
        <button class="btn grey" style="max-width:70px;" onclick="stopFaceCam();goStep(3)">â† Back</button>
        <button class="btn blue" id="btnFace" onclick="captureFace()" disabled>ğŸ“¸ Start Face Scan</button>
      </div>
      <button class="btn grey" id="btnManual" onclick="manualFace()" style="margin-top:8px;display:none;font-size:13px;">ğŸ“· Manual Capture</button>
    </div>

    <!-- 4c: Preview -->
    <div id="s4c" style="display:none;">
      <div class="prev"><canvas id="faceCanvas"></canvas><div class="prev-badge">âœ… 3 frames averaged</div></div>
      <div class="al ok" style="margin-bottom:10px;">ğŸ¯ Face captured from 3 frames for best accuracy</div>
      <div class="btn-row">
        <button class="btn grey" style="max-width:110px;" onclick="retakeFace()">ğŸ”„ Retake</button>
        <button class="btn green" id="btnReg" onclick="doRegister()">âœ… Complete Registration</button>
      </div>
    </div>
  </div>

  <!-- â”€â”€â”€ STEP 5: Done â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div id="step5" style="display:none;">
    <div id="s5content"></div>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var reg={}, proofType=null, proofOK=false, finalDesc=null;
var faceDescs=[], faceCapturing=false, faceStream=null, faceLoop=null;
var faceModels=false, facingMode='user', faceBoostOn=false, faceLux=150;
var docStream=null, docFacing='environment', docBoostOn=false, docLux=150, docLightLoop=null;
var otpCountdown=null;
var CDN1='https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/weights';
var CDN2='https://raw.githubusercontent.com/justadudewhohacks/face-api.js/master/weights';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NAVIGATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function goStep(n){
  for(var i=1;i<=5;i++){
    var el=document.getElementById('step'+i);
    if(el) el.style.display=i===n?'block':'none';
  }
  var pids=['sp1','sp2','sp3','sp4','sp5'];
  for(var j=0;j<pids.length;j++){
    var p=document.getElementById(pids[j]);
    if(p) p.className='sp'+(j+1<n?' done':j+1===n?' active':'');
  }
  window.scrollTo({top:0,behavior:'smooth'});
}
function al(id,type,msg){
  var el=document.getElementById(id);
  if(el) el.innerHTML=msg?'<div class="al '+type+'">'+msg+'</div>':'';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STEP 1 â€” Info (NO age restriction)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function s1Next(){
  al('e1','','');
  var name  = document.getElementById('fName').value.trim();
  var dob   = document.getElementById('fDob').value;
  var phone = document.getElementById('fPhone').value.replace(/\D/g,'');
  var addr  = document.getElementById('fAddr').value.trim();

  if(!name || name.length < 2){
    al('e1','err','âš ï¸ Full name is required.');
    document.getElementById('fName').focus(); return;
  }
  if(!dob){
    al('e1','err','âš ï¸ Date of birth is required.');
    document.getElementById('fDob').focus(); return;
  }
  if(phone.length < 10){
    al('e1','err','âš ï¸ Enter a valid 10-digit mobile number.');
    document.getElementById('fPhone').focus(); return;
  }

  // ES5-compatible object (no shorthand)
  reg = { name:name, dob:dob, phone:phone, address:addr };
  document.getElementById('phoneDisp').textContent = '+91 ' + phone;
  goStep(2);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STEP 2 â€” OTP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildOtp(){
  var row=document.getElementById('otpRow');
  if(!row){ console.error('otpRow not found'); return; }
  row.innerHTML='';
  for(var i=0;i<6;i++){
    (function(idx){
      var inp=document.createElement('input');
      inp.type='tel'; inp.maxLength=1; inp.className='otp-d'; inp.id='od'+idx; inp.inputMode='numeric';
      inp.addEventListener('input',function(){
        this.value=this.value.replace(/\D/g,'');
        if(this.value&&idx<5){ var nx=document.getElementById('od'+(idx+1)); if(nx) nx.focus(); }
        refreshVerify();
      });
      inp.addEventListener('keydown',function(e){
        if(e.key==='Backspace'&&!this.value&&idx>0){ var pv=document.getElementById('od'+(idx-1)); if(pv) pv.focus(); }
      });
      row.appendChild(inp);
    })(i);
  }
  row.addEventListener('paste',function(e){
    var txt=(e.clipboardData||window.clipboardData).getData('text').replace(/\D/g,'').slice(0,6);
    if(txt.length===6){for(var k=0;k<6;k++){var d=document.getElementById('od'+k);if(d){d.value=txt[k];d.className='otp-d ok';}}refreshVerify();e.preventDefault();}
  });
}

function refreshVerify(){
  var full=true;
  for(var i=0;i<6;i++){var d=document.getElementById('od'+i);if(!d||!d.value){full=false;d&&(d.className='otp-d');}else d.className='otp-d ok';}
  document.getElementById('btnVerify').disabled=!full;
}

async function sendOtp(){
  var btn=document.getElementById('btnSend');
  btn.disabled=true; btn.innerHTML='<span class="spin"></span> Sendingâ€¦';
  al('e2','','');
  try{
    var res=await fetch('/api/otp/send',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({phone:reg.phone})});
    var data=await res.json();
    if(!res.ok) throw new Error(data.error);
    document.getElementById('otpSend').style.display='none';
    document.getElementById('otpEntry').style.display='block';
    document.getElementById('od0').focus();
    if(data.demoOtp){var h=document.getElementById('otpHint');h.style.display='block';h.textContent='ğŸ“± Demo OTP: '+data.demoOtp;}
    startOtpCd(300);
    al('e2','ok','âœ… '+data.message);
  }catch(e){al('e2','err','âŒ '+e.message);btn.disabled=false;btn.innerHTML='ğŸ“¤ Send OTP';}
}

function startOtpCd(s){
  clearInterval(otpCountdown);
  otpCountdown=setInterval(function(){
    s--;var m=Math.floor(s/60),sec=s%60;
    var el=document.getElementById('otpTimer');
    if(el) el.textContent='OTP expires in '+m+':'+(sec<10?'0':'')+sec;
    if(s<=0){clearInterval(otpCountdown);if(el)el.textContent='OTP expired. Please resend.';}
  },1000);
}

function resetOtp(){
  clearInterval(otpCountdown);
  document.getElementById('otpSend').style.display='block';
  document.getElementById('otpEntry').style.display='none';
  for(var i=0;i<6;i++){var d=document.getElementById('od'+i);if(d){d.value='';d.className='otp-d';}}
  document.getElementById('otpHint').style.display='none';
  document.getElementById('btnVerify').disabled=true;
  var btn=document.getElementById('btnSend');btn.disabled=false;btn.innerHTML='ğŸ“¤ Send OTP';
  al('e2','','');
}

async function verifyOtp(){
  var otp='';for(var i=0;i<6;i++){var d=document.getElementById('od'+i);otp+=(d?d.value:'');}
  if(otp.length<6) return al('e2','err','Enter the complete 6-digit OTP.');
  var btn=document.getElementById('btnVerify');
  btn.disabled=true;btn.innerHTML='<span class="spin"></span> Verifyingâ€¦';
  al('e2','','');
  try{
    var res=await fetch('/api/otp/verify',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({phone:reg.phone,otp})});
    var data=await res.json();
    if(!res.ok) throw new Error(data.error);
    clearInterval(otpCountdown);
    reg.phoneVerified=true;
    al('e2','ok','âœ… Phone verified!');
    setTimeout(function(){goStep(3);showS3a();},700);
  }catch(e){al('e2','err','âŒ '+e.message);btn.disabled=false;btn.innerHTML='âœ… Verify OTP';}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STEP 3 â€” ID Proof
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showS3a(){
  document.getElementById('s3a').style.display='block';
  document.getElementById('s3b').style.display='none';
  document.getElementById('s3c').style.display='none';
}

function pickProof(type){
  proofType=type;
  document.getElementById('pc-a').classList.toggle('sel',type==='aadhaar');
  document.getElementById('pc-c').classList.toggle('sel',type==='college');
  document.getElementById('btnGoScan').disabled=false;
  var tip=document.getElementById('proofTip');tip.style.display='block';
  if(type==='aadhaar'){
    tip.innerHTML='<div class="al info" style="margin:0;font-size:12px;">ğŸªª <strong>Aadhaar Tips:</strong> Show the FRONT with photo. Name and DOB must be clearly visible. No glare.</div>';
  }else{
    tip.innerHTML='<div class="al warn" style="margin:0;font-size:12px;">ğŸ“ <strong>College ID Tips:</strong> Must show full Name AND Date of Birth. IDs without DOB will fail verification.</div>';
  }
}

function startScan(){
  if(!proofType) return al('e3a','err','Select an ID type first.');
  document.getElementById('s3a').style.display='none';
  document.getElementById('s3b').style.display='block';
  document.getElementById('s3c').style.display='none';
  document.getElementById('scanTitle').textContent=proofType==='aadhaar'?'ğŸ“· Scan Aadhaar Card':'ğŸ“· Scan College ID';
  // Sub changes per device
  document.getElementById('scanSub').textContent=isMobile
    ?'Hold document flat inside the frame â€” all 4 corners visible'
    :'Hold document up to your webcam â€” fill the frame, keep steady';
  document.getElementById('docTipBox').innerHTML=proofType==='aadhaar'
    ?'<div class="al info" style="margin:0;font-size:12px;">ğŸªª Show front side: photo, name &amp; DOB all visible. No shadows or glare.</div>'
    :'<div class="al warn" style="margin:0;font-size:12px;">ğŸ“ Show full name, DOB and college name clearly. All text must be readable.</div>';
  openDocCam();
}

// â”€â”€â”€ Device detection â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var isMobile = /Android|iPhone|iPad|iPod|Mobile/i.test(navigator.userAgent);
var availableCameras = [];   // list of {deviceId, label}
var selectedCameraId = null;

async function detectCameras(){
  try{
    // Must request permission first so labels are readable
    var tmpStream = await navigator.mediaDevices.getUserMedia({video:true});
    tmpStream.getTracks().forEach(function(t){t.stop();});
    var devices = await navigator.mediaDevices.enumerateDevices();
    availableCameras = devices
      .filter(function(d){return d.kind==='videoinput';})
      .map(function(d,i){return {deviceId:d.deviceId, label:d.label||('Camera '+(i+1))};});
  }catch(e){ availableCameras=[]; }
}

function populateCameraSelect(){
  var wrap = document.getElementById('camSelectWrap');
  var sel  = document.getElementById('camSelect');
  if(availableCameras.length <= 1){ wrap.style.display='none'; return; }
  sel.innerHTML='';
  availableCameras.forEach(function(cam,i){
    var opt=document.createElement('option');
    opt.value=cam.deviceId;
    // Label rear/back cameras more clearly
    var lbl=cam.label;
    if(/back|rear|environment/i.test(lbl)) lbl='ğŸ“· Rear Camera â€” '+lbl;
    else if(/front|face|user/i.test(lbl))  lbl='ğŸ¤³ Front Camera â€” '+lbl;
    else lbl='ğŸ“· '+(i===0?'Main Camera':'Camera '+(i+1))+' â€” '+lbl;
    opt.textContent=lbl;
    sel.appendChild(opt);
  });
  // Default: prefer rear camera on mobile, first camera on desktop
  if(isMobile){
    var rearIdx = availableCameras.findIndex(function(c){return /back|rear|environment/i.test(c.label);});
    if(rearIdx>=0) sel.selectedIndex=rearIdx;
  }
  selectedCameraId = sel.value;
  wrap.style.display='block';
}

async function switchCamera(){
  selectedCameraId = document.getElementById('camSelect').value;
  stopDocCam();
  await openDocCam();
}

// â”€â”€â”€ Document Camera â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function openDocCam(){
  document.getElementById('docLoading').style.display='block';
  document.getElementById('docCamWrap').style.display='none';
  document.getElementById('docLoadTxt').textContent='Detecting camerasâ€¦';

  // Detect cameras first time
  if(availableCameras.length===0) await detectCameras();
  populateCameraSelect();

  // Build constraints
  var constraints;
  if(selectedCameraId){
    // Exact camera chosen from dropdown
    constraints = {video:{deviceId:{exact:selectedCameraId},width:{ideal:1920},height:{ideal:1080},frameRate:{ideal:30}}};
  } else if(isMobile){
    // Mobile: prefer rear camera
    constraints = {video:{facingMode:{ideal:'environment'},width:{ideal:1920},height:{ideal:1080},frameRate:{ideal:30},advanced:[{focusMode:'continuous'},{exposureMode:'continuous'}]}};
  } else {
    // Laptop/PC: use any available camera (usually webcam)
    constraints = {video:{width:{ideal:1280},height:{ideal:720},frameRate:{ideal:30}}};
  }

  document.getElementById('docLoadTxt').textContent='Starting cameraâ€¦';
  try{
    docStream = await navigator.mediaDevices.getUserMedia(constraints)
      .catch(function(){
        // Fallback: just ask for any video
        return navigator.mediaDevices.getUserMedia({video:true});
      });
  }catch(e){
    al('e3b','err','ğŸ“· Camera not found or blocked. Allow camera permission and refresh the page.');
    document.getElementById('docLoading').style.display='none';
    return;
  }

  var v=document.getElementById('docVid');
  v.srcObject=docStream; v.play();
  applyDocFilter();

  // Show flip button only on mobile (desktops have camera selector dropdown instead)
  document.getElementById('btnFlipDoc').style.display = isMobile ? 'flex' : 'none';

  // Set instructions based on device type
  var bar = document.getElementById('docBar');
  var hint = document.getElementById('docHint');
  var tip  = document.getElementById('deviceTip');

  if(isMobile){
    bar.textContent = 'ğŸ“„ Place document flat â€” all 4 corners inside the frame';
    hint.textContent = 'ğŸ”„ flip camera Â· â˜€ï¸ boost light Â· Keep document flat, no glare';
    tip.style.display = 'none';
  } else {
    bar.textContent = 'ğŸ“„ Hold document up to your webcam â€” fill the frame';
    hint.textContent = 'Hold document flat facing the webcam Â· Good lighting Â· Keep steady';
    tip.style.display = 'block';
    tip.innerHTML = '<div class="al info" style="margin:0;font-size:12px;">'
      +'ğŸ’» <strong>Laptop/PC mode:</strong> Hold your '+(proofType==='aadhaar'?'Aadhaar card':'College ID')+' flat up to your webcam. '
      +'Make sure all text is clearly readable. Use a desk lamp or face a window for best results.'
      +'</div>';
  }

  document.getElementById('docLoading').style.display='none';
  document.getElementById('docCamWrap').style.display='block';
  startDocLight();
}

function applyDocFilter(){
  var v=document.getElementById('docVid');
  if(v) v.style.filter=docBoostOn?'brightness(2.2) contrast(1.7) saturate(0.8)':'brightness(1.4) contrast(1.2)';
}

function flipDocCam(){
  // Mobile only: toggle front/back
  stopDocCam();
  docFacing = docFacing==='environment'?'user':'environment';
  selectedCameraId = null; // clear so facingMode constraint is used
  openDocCam();
}

function toggleDocBoost(){docBoostOn=!docBoostOn;document.getElementById('docBoost').classList.toggle('on',docBoostOn);applyDocFilter();}

function startDocLight(){
  clearInterval(docLightLoop);
  docLightLoop=setInterval(function(){
    var v=document.getElementById('docVid');if(!v||!v.videoWidth)return;
    try{
      var c=document.createElement('canvas');c.width=80;c.height=50;
      var ctx=c.getContext('2d');ctx.drawImage(v,0,0,80,50);
      var px=ctx.getImageData(0,0,80,50).data,s=0;
      for(var i=0;i<px.length;i+=16)s+=(px[i]+px[i+1]+px[i+2])/3;
      docLux=s/(px.length/16);
      var chip=document.getElementById('docLx');if(!chip)return;
      if(docLux<50){chip.textContent='ğŸŒ‘ Very Dark';chip.style.background='rgba(120,53,15,.85)';if(!docBoostOn){docBoostOn=true;applyDocFilter();document.getElementById('docBoost').classList.add('on');}}
      else if(docLux<90){chip.textContent='ğŸŒ™ Low';chip.style.background='rgba(100,50,0,.85)';}
      else if(docLux<160){chip.textContent='ğŸ’¡ OK';chip.style.background='rgba(0,0,0,.6)';}
      else{chip.textContent='â˜€ï¸ Good';chip.style.background='rgba(5,80,40,.85)';}
    }catch(e){}
  },800);
}

function stopDocCam(){
  clearInterval(docLightLoop);docLightLoop=null;
  if(docStream){docStream.getTracks().forEach(function(t){t.stop();});docStream=null;}
}

// â”€â”€â”€ Capture & OCR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function captureDoc(){
  var btn=document.getElementById('btnCap');
  btn.disabled=true;btn.innerHTML='<span class="spin-b"></span> Capturingâ€¦';
  document.getElementById('docFrame').className='doc-frame scan';
  await new Promise(function(r){setTimeout(r,500);});

  var vid=document.getElementById('docVid');
  var cnv=document.getElementById('docCanvas');
  cnv.width=vid.videoWidth||1280;cnv.height=vid.videoHeight||720;
  var ctx=cnv.getContext('2d');

  // On laptop/PC the webcam image is often mirrored â€” un-mirror it for OCR
  var track = docStream && docStream.getVideoTracks()[0];
  var settings = track ? track.getSettings() : {};
  var facingEnv = settings.facingMode==='environment' || (!isMobile && docFacing!=='user');

  if(!isMobile && !facingEnv){
    // Un-mirror: flip horizontally so text reads correctly
    ctx.save();
    ctx.translate(cnv.width, 0);
    ctx.scale(-1, 1);
  }

  // Apply lighting enhancement
  var bri=docLux<70?2.2:docLux<120?1.7:1.4;
  var con=docLux<70?2.0:docLux<120?1.6:1.3;
  ctx.filter='brightness('+bri+') contrast('+con+')';
  ctx.drawImage(vid,0,0);

  if(!isMobile && !facingEnv) ctx.restore();

  document.getElementById('docFrame').className='doc-frame good';
  stopDocCam();
  document.getElementById('s3b').style.display='none';
  document.getElementById('s3c').style.display='block';
  document.getElementById('ocrLoading').style.display='block';
  document.getElementById('ocrResult').style.display='none';
  document.getElementById('ocrActions').style.display='none';
  await runOCR(cnv);
}

// â”€â”€â”€ Advanced image preprocessing before OCR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function preprocessForOCR(srcCanvas){
  var W=srcCanvas.width,H=srcCanvas.height;
  var dst=document.createElement('canvas');
  var scale=Math.max(1,Math.min(2, 1600/Math.max(W,H)));
  dst.width=Math.round(W*scale); dst.height=Math.round(H*scale);
  var ctx=dst.getContext('2d');

  // Step 1: upscale with smoothing
  ctx.imageSmoothingEnabled=true; ctx.imageSmoothingQuality='high';
  ctx.drawImage(srcCanvas,0,0,dst.width,dst.height);

  // Step 2: get pixel data
  var idata=ctx.getImageData(0,0,dst.width,dst.height);
  var px=idata.data,n=px.length;

  // Step 3: grayscale + contrast stretch + adaptive threshold
  var grays=new Uint8Array(n/4);
  var mn=255,mx=0;
  for(var i=0;i<n;i+=4){
    // Luminance-weighted grayscale
    var g=Math.round(0.299*px[i]+0.587*px[i+1]+0.114*px[i+2]);
    grays[i/4]=g;
    if(g<mn)mn=g; if(g>mx)mx=g;
  }

  // Auto-level (stretch contrast)
  var rng=mx-mn||1;
  for(var j=0;j<grays.length;j++) grays[j]=Math.round((grays[j]-mn)/rng*255);

  // Write back sharpened grayscale
  for(var k=0;k<n;k+=4){
    var v=grays[k/4];
    // Soft threshold to improve text clarity
    v = v < 128 ? Math.max(0, v*0.7) : Math.min(255, 50 + v*0.8);
    px[k]=px[k+1]=px[k+2]=v; px[k+3]=255;
  }
  ctx.putImageData(idata,0,0);

  // Step 4: unsharp mask (simple version via shadow canvas)
  var blur=document.createElement('canvas');blur.width=dst.width;blur.height=dst.height;
  var bctx=blur.getContext('2d');
  bctx.filter='blur(1.5px)'; bctx.drawImage(dst,0,0);
  var bi=bctx.getImageData(0,0,dst.width,dst.height).data;
  var sharp=ctx.getImageData(0,0,dst.width,dst.height);
  var sp=sharp.data;
  for(var s=0;s<sp.length;s+=4){
    sp[s]  =Math.min(255,Math.max(0, sp[s]  *1.8 - bi[s]  *0.8));
    sp[s+1]=Math.min(255,Math.max(0, sp[s+1]*1.8 - bi[s+1]*0.8));
    sp[s+2]=Math.min(255,Math.max(0, sp[s+2]*1.8 - bi[s+2]*0.8));
  }
  ctx.putImageData(sharp,0,0);
  return dst;
}

async function runOCR(canvas){
  if(typeof Tesseract==='undefined'){
    document.getElementById('ocrTxt').textContent='Loading OCR engineâ€¦';
    await loadScript('https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js');
  }
  try{
    document.getElementById('ocrTxt').textContent='Preprocessing imageâ€¦';
    document.getElementById('ocrBar').style.width='8%';

    // Run on BOTH original (colour) and preprocessed (b&w) â€” take best result
    var preprocessed=preprocessForOCR(canvas);

    document.getElementById('ocrTxt').textContent='Running OCRâ€¦';
    document.getElementById('ocrBar').style.width='15%';

    var worker=await Tesseract.createWorker('eng',1,{
      logger:function(m){
        if(m.status==='recognizing text'){
          var p=Math.round(m.progress*70)+20;
          document.getElementById('ocrBar').style.width=p+'%';
          document.getElementById('ocrTxt').textContent='Reading textâ€¦ '+p+'%';
        }
      }
    });

    await worker.setParameters({
      tessedit_char_whitelist:'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789:/- ',
      preserve_interword_spaces:'1',
    });

    // Run OCR on preprocessed image
    var r1=await worker.recognize(preprocessed);
    // Run OCR on original for comparison
    var r2=await worker.recognize(canvas);
    await worker.terminate();

    // Merge both texts
    var combined=r1.data.text+'\n'+r2.data.text;
    document.getElementById('ocrBar').style.width='100%';
    document.getElementById('ocrTxt').textContent='Analysingâ€¦';
    await new Promise(function(r){setTimeout(r,400);});
    showOCRResult(combined, r1.data.confidence);

  }catch(e){
    document.getElementById('ocrLoading').style.display='none';
    document.getElementById('ocrResult').style.display='block';
    document.getElementById('ocrResult').innerHTML='<div class="al err">âŒ OCR failed: '+e.message+'. Try better lighting.</div>';
    document.getElementById('ocrActions').style.display='block';
    document.getElementById('btnAccept').style.display='none';
  }
}

// â”€â”€â”€ OCR Result Analysis â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showOCRResult(rawText, confidence){
  document.getElementById('ocrLoading').style.display='none';
  document.getElementById('ocrResult').style.display='block';
  document.getElementById('ocrActions').style.display='block';

  var text=rawText;
  var textUP=text.toUpperCase();

  // â”€â”€ Detect document type from content â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  var detectedAadhaar = /UNIQUE\s*IDENT|GOVERNMENT\s*OF\s*INDIA|UIDAI|AADHAAR|\d{4}\s*\d{4}\s*\d{4}/i.test(text);
  var detectedCollege = /COLLEGE|UNIVERSITY|INSTITUTE|STUDENT|ENROLL|ROLL\s*NO/i.test(text);

  // â”€â”€ Extract Aadhaar number (12 digits) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  var aadhaarNum=null;
  var anm=text.match(/\b(\d{4})\s*(\d{4})\s*(\d{4})\b/);
  if(anm) aadhaarNum=anm[1]+' '+anm[2]+' '+anm[3];

  // â”€â”€ Extract DOB â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  var dobRaw=null, dobISO=null;
  var dobPatterns=[
    // Aadhaar: DOB: DD/MM/YYYY or DD-MM-YYYY
    /\bDOB\s*[:\-]?\s*(\d{1,2}[\/\-\.]\d{1,2}[\/\-\.]\d{4})\b/i,
    /\bDate\s*of\s*Birth\s*[:\-]?\s*(\d{1,2}[\/\-\.]\d{1,2}[\/\-\.]\d{4})\b/i,
    /\bBirth\s*Date\s*[:\-]?\s*(\d{1,2}[\/\-\.]\d{1,2}[\/\-\.]\d{4})\b/i,
    /\bBirth\s*[:\-]?\s*(\d{1,2}[\/\-\.]\d{1,2}[\/\-\.]\d{4})\b/i,
    // Bare DD/MM/YYYY
    /\b(\d{2}[\/\-\.]\d{2}[\/\-\.]\d{4})\b/,
    // Year of Birth (Aadhaar sometimes shows only year)
    /\bYear\s*of\s*Birth\s*[:\-]?\s*(\d{4})\b/i,
    /\bYOB\s*[:\-]?\s*(\d{4})\b/i,
    // Age-based extraction: sometimes shows Age: XX
    /\bAge\s*[:\-]\s*(\d{1,3})\b/i,
  ];

  for(var pi=0;pi<dobPatterns.length;pi++){
    var m=text.match(dobPatterns[pi]);
    if(!m) continue;
    var val=m[1];

    if(dobPatterns[pi].source.indexOf('Age')>-1){
      // Age-based: calculate approximate birth year
      var yr=new Date().getFullYear()-parseInt(val);
      dobISO=yr+'-01-01'; dobRaw='~Age '+val+' (Born ~'+yr+')';
      break;
    }

    var parts=val.split(/[\/\-\.]/);
    if(parts.length===3){
      if(parts[2].length===4){
        // DD/MM/YYYY
        dobISO=parts[2]+'-'+parts[1].padStart(2,'0')+'-'+parts[0].padStart(2,'0');
        dobRaw=val; break;
      } else if(parts[0].length===4){
        // YYYY/MM/DD
        dobISO=parts[0]+'-'+parts[1].padStart(2,'0')+'-'+parts[2].padStart(2,'0');
        dobRaw=val; break;
      }
    } else if(parts.length===1&&val.length===4){
      // Year only
      dobISO=val+'-01-01'; dobRaw='Year: '+val; break;
    }
  }

  // â”€â”€ DOB match â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  var dobMatch=false, dobPartial=false;
  if(dobISO&&reg.dob){
    var regDate=new Date(reg.dob), extDate=new Date(dobISO);
    var diffMs=Math.abs(regDate-extDate);
    dobMatch = diffMs < 2*24*60*60*1000;  // within 2 days
    // Year-only match (partial)
    if(!dobMatch && dobISO.slice(0,4)===reg.dob.slice(0,4)) dobPartial=true;
  }

  // â”€â”€ Name match â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  var nameMatch=false, foundName='', bestScore=0;
  var lines=text.split('\n');
  var regWords=reg.name.toUpperCase().split(/\s+/).filter(function(w){return w.length>1;});

  for(var li=0;li<lines.length;li++){
    var lineUp=lines[li].toUpperCase().replace(/[^A-Z\s]/g,'').trim();
    if(lineUp.length<3) continue;
    var hits=0;
    for(var wi=0;wi<regWords.length;wi++) if(lineUp.indexOf(regWords[wi])>=0) hits++;
    var score=hits/Math.max(1,regWords.length);
    if(score>bestScore){bestScore=score;foundName=lines[li].trim();}
  }
  nameMatch=bestScore>=0.6;

  // â”€â”€ Document authenticity markers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  var hasAuthMarker = proofType==='aadhaar'
    ? (detectedAadhaar||!!aadhaarNum)
    : (detectedCollege||nameMatch);

  // â”€â”€ Overall decision â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // DOB must match (or partial) to accept
  var accepted = dobMatch || (dobPartial && nameMatch);
  var confidence_pct = Math.round(confidence||0);

  // â”€â”€ Build result HTML â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  var boxClass = accepted ? 'ok' : (dobPartial ? 'warn' : 'fail');
  var html='<div class="ocr-box '+boxClass+'">';
  html+='<div style="font-weight:800;font-size:13px;margin-bottom:12px;color:'+(accepted?'#15803d':dobPartial?'#92400e':'#b91c1c')+'">'+(accepted?'âœ… Document Verified':dobPartial?'âš ï¸ Partial Match':'âŒ Verification Failed')+'</div>';

  // Name row
  html+='<div class="ocr-row"><span class="ocr-k">Name</span><span class="ocr-v">'+(foundName||'Not detected')+'</span><span class="tag '+(nameMatch?'ok':'fail')+'">'+(nameMatch?'Match':'No match')+'</span></div>';

  // DOB row
  html+='<div class="ocr-row"><span class="ocr-k">DOB</span><span class="ocr-v">'+(dobRaw||'Not found')+'</span><span class="tag '+(dobMatch?'ok':dobPartial?'warn':'fail')+'">'+(dobMatch?'Match':dobPartial?'Year match':'No match')+'</span></div>';

  // Aadhaar number if found
  if(aadhaarNum) html+='<div class="ocr-row"><span class="ocr-k">UID</span><span class="ocr-v" style="font-family:monospace;">****'+aadhaarNum.slice(-5)+'</span><span class="tag ok">Found</span></div>';

  // Doc type
  html+='<div class="ocr-row"><span class="ocr-k">Type</span><span class="ocr-v">'+(proofType==='aadhaar'?'Aadhaar Card':'College ID')+'</span><span class="tag '+(hasAuthMarker?'ok':'warn')+'">'+(hasAuthMarker?'Verified':'Check document')+'</span></div>';

  // Registered info
  html+='<div style="margin-top:10px;padding-top:10px;border-top:1px solid '+(accepted?'#bbf7d0':dobPartial?'#fde68a':'#fecaca')+';font-size:12px;color:#64748b;">';
  html+='Registered as: <strong>'+reg.name+'</strong> Â· DOB: <strong>'+reg.dob+'</strong></div>';

  // Confidence meter
  html+='<div style="margin-top:8px;font-size:11px;color:#64748b;">OCR Confidence: '+confidence_pct+'%</div>';
  html+='<div class="conf-bar"><div class="conf-fill" style="width:'+confidence_pct+'%;background:'+(confidence_pct>70?'#10b981':confidence_pct>40?'#f59e0b':'#ef4444')+'"></div></div>';
  html+='</div>';

  // Extra guidance
  if(!dobMatch&&!dobPartial){
    html+='<div class="al err" style="margin-top:8px;font-size:12px;">âŒ DOB not found or doesn\'t match. Ensure DOB is fully visible, no glare, document is flat. Retake and try again.</div>';
  } else if(dobPartial&&!accepted){
    html+='<div class="al warn" style="margin-top:8px;font-size:12px;">âš ï¸ Only year matched. For stronger verification, show the full DOB line clearly.</div>';
    accepted=true; // Allow proceed with partial match + name match
  }

  document.getElementById('ocrResult').innerHTML=html;

  var acc=document.getElementById('btnAccept');
  if(accepted){acc.style.display='flex';}
  else{acc.style.display='none';}
}

function acceptProof(){
  proofOK=true; reg.proofType=proofType;
  stopDocCam(); goStep(4); loadFaceStep();
}

function retryDoc(){
  document.getElementById('s3c').style.display='none';
  document.getElementById('s3b').style.display='block';
  document.getElementById('docLoading').style.display='block';
  document.getElementById('docCamWrap').style.display='none';
  document.getElementById('btnCap').disabled=false;
  document.getElementById('btnCap').innerHTML='ğŸ“¸ Capture';
  document.getElementById('docFrame').className='doc-frame';
  openDocCam();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STEP 4 â€” Face
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadFaceStep(){
  showFacePanel('load');
  setAI('Starting cameraâ€¦',8);
  try{
    faceStream=await navigator.mediaDevices.getUserMedia({
      video:{facingMode:facingMode,width:{ideal:1280},height:{ideal:960},frameRate:{ideal:30},
        advanced:[{exposureMode:'continuous'},{whiteBalanceMode:'continuous'}]}
    }).catch(function(){return navigator.mediaDevices.getUserMedia({video:{facingMode:facingMode}});});
  }catch(e){
    showFacePanel('cam');
    al('e4','err','ğŸ“· Camera blocked. Allow camera permission and refresh.');
    return;
  }
  var v=document.getElementById('faceVid');v.srcObject=faceStream;v.play();
  applyFaceFilter();
  if(typeof faceapi==='undefined'){
    setAI('Loading face-apiâ€¦',12);
    await loadScript('https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js');
  }
  await loadFaceModels();
}

function showFacePanel(p){
  document.getElementById('s4a').style.display=p==='load'?'block':'none';
  document.getElementById('s4b').style.display=p==='cam'?'block':'none';
  document.getElementById('s4c').style.display=p==='prev'?'block':'none';
}
function setAI(t,p){var a=document.getElementById('aiTxt');if(a)a.textContent=t;var b=document.getElementById('aiBar');if(b)b.style.width=p+'%';}
function applyFaceFilter(){
  var v=document.getElementById('faceVid');
  if(v) v.style.filter=faceBoostOn?'brightness(2.2) contrast(1.6)':'brightness(1.5) contrast(1.25)';
}
function flipFaceCam(){stopFaceCam();facingMode=facingMode==='user'?'environment':'user';loadFaceStep();}
function toggleFaceBoost(){faceBoostOn=!faceBoostOn;document.getElementById('faceBoost').classList.toggle('on',faceBoostOn);applyFaceFilter();}

async function loadFaceModels(){
  if(faceModels){onFaceReady();return;}
  var cdns=[CDN1,CDN2];
  for(var ci=0;ci<cdns.length;ci++){
    try{
      setAI('Loading detectorâ€¦',30);await faceapi.nets.ssdMobilenetv1.loadFromUri(cdns[ci]);
      setAI('Loading landmarksâ€¦',58);await faceapi.nets.faceLandmark68Net.loadFromUri(cdns[ci]);
      setAI('Loading recognitionâ€¦',82);await faceapi.nets.faceRecognitionNet.loadFromUri(cdns[ci]);
      faceModels=true;setAI('âœ… Ready!',100);setTimeout(onFaceReady,300);return;
    }catch(e){}
  }
  // Tiny fallback
  for(var ci2=0;ci2<cdns.length;ci2++){
    try{
      await faceapi.nets.tinyFaceDetector.loadFromUri(cdns[ci2]);
      await faceapi.nets.faceLandmark68TinyNet.loadFromUri(cdns[ci2]);
      await faceapi.nets.faceRecognitionNet.loadFromUri(cdns[ci2]);
      faceModels=true;window._tiny=true;setTimeout(onFaceReady,300);return;
    }catch(e){}
  }
  al('e4','warn','âš ï¸ AI unavailable. Using manual capture.');
  showFacePanel('cam');
  var b=document.getElementById('btnFace');b.disabled=false;b.textContent='ğŸ“· Manual Capture';b.onclick=manualFace;
}

function onFaceReady(){
  showFacePanel('cam'); startFaceLoop();
  setTimeout(function(){if(document.getElementById('btnFace').disabled)document.getElementById('btnManual').style.display='flex';},18000);
}

function getOpts(sz){
  sz=sz||512;
  return window._tiny
    ?new faceapi.TinyFaceDetectorOptions({inputSize:sz,scoreThreshold:0.25})
    :new faceapi.SsdMobilenetv1Options({minConfidence:0.28});
}

function startFaceLoop(){
  var vid=document.getElementById('faceVid');
  faceLoop=setInterval(async function(){
    if(!vid.videoWidth||faceCapturing)return;
    measureFaceLux(vid);
    try{
      var f=enhanceFrame(vid);
      var det=await faceapi.detectSingleFace(f,getOpts()).withFaceLandmarks()
             ||await faceapi.detectSingleFace(vid,getOpts()).withFaceLandmarks();
      if(det){
        document.getElementById('faceOval').className='oval rdy';
        document.getElementById('faceTxt').textContent='âœ… Face detected! Tap Start Face Scan';
        document.getElementById('btnFace').disabled=false;
        document.getElementById('btnManual').style.display='none';
      }else{
        document.getElementById('faceOval').className='oval';
        document.getElementById('faceTxt').textContent=faceLux<60?'ğŸŒ™ Too dark â€” tap â˜€ï¸ or move to light':'ğŸ‘¤ Align face inside the oval';
        document.getElementById('btnFace').disabled=true;
      }
    }catch(e){}
  },300);
}

async function captureFace(){
  if(faceCapturing)return;
  faceCapturing=true;faceDescs=[];
  clearInterval(faceLoop);
  document.getElementById('btnFace').disabled=true;
  document.getElementById('faceDots').style.display='flex';
  var vid=document.getElementById('faceVid'),snap=null;
  for(var i=0;i<3;i++){
    setDot(i);
    document.getElementById('faceTxt').textContent='ğŸ“¸ Frame '+(i+1)+' of 3â€¦';
    var f=enhanceFrame(vid);
    var det=await faceapi.detectSingleFace(f,getOpts(640)).withFaceLandmarks().withFaceDescriptor()
           ||await faceapi.detectSingleFace(vid,getOpts(640)).withFaceLandmarks().withFaceDescriptor();
    if(!det){
      faceCapturing=false;
      document.getElementById('faceDots').style.display='none';
      document.getElementById('faceOval').className='oval bad';
      document.getElementById('faceTxt').textContent='âŒ Face lost â€” hold still and retry';
      document.getElementById('btnFace').disabled=false;
      setTimeout(function(){document.getElementById('faceOval').className='oval';startFaceLoop();},2000);
      return;
    }
    faceDescs.push(det.descriptor);if(i===0)snap=vid;
    await new Promise(function(r){setTimeout(r,300);});
  }
  for(var j=0;j<3;j++)document.getElementById('d'+j).className='dot f';
  document.getElementById('faceTxt').textContent='âœ… All 3 frames captured!';
  await new Promise(function(r){setTimeout(r,500);});
  finalDesc=avgDescs(faceDescs);
  var cnv=document.getElementById('faceCanvas');
  cnv.width=snap.videoWidth;cnv.height=snap.videoHeight;
  var ctx=cnv.getContext('2d');ctx.filter='brightness(1.15)';ctx.drawImage(snap,0,0);
  showFacePanel('prev');faceCapturing=false;
}

function setDot(active){
  for(var j=0;j<3;j++) document.getElementById('d'+j).className='dot'+(j<active?' f':j===active?' a':'');
}

async function manualFace(){
  faceCapturing=true;clearInterval(faceLoop);
  var vid=document.getElementById('faceVid'),det=null;
  var confs=[0.25,0.15,0.07];
  for(var ci=0;ci<confs.length;ci++){
    var o=window._tiny?new faceapi.TinyFaceDetectorOptions({inputSize:608,scoreThreshold:confs[ci]}):new faceapi.SsdMobilenetv1Options({minConfidence:confs[ci]});
    det=await faceapi.detectSingleFace(enhanceFrame(vid),o).withFaceLandmarks().withFaceDescriptor()
       ||await faceapi.detectSingleFace(vid,o).withFaceLandmarks().withFaceDescriptor();
    if(det)break;
  }
  finalDesc=det?det.descriptor:new Float32Array(pixelFP(vid));
  if(!det)al('e4','warn','âš ï¸ Manual capture used â€” accuracy may be lower.');
  var cnv=document.getElementById('faceCanvas');
  cnv.width=vid.videoWidth||480;cnv.height=vid.videoHeight||360;
  cnv.getContext('2d').drawImage(vid,0,0);
  showFacePanel('prev');faceCapturing=false;
}

function retakeFace(){
  finalDesc=null;faceDescs=[];faceCapturing=false;
  document.getElementById('faceDots').style.display='none';
  document.getElementById('faceOval').className='oval';
  document.getElementById('btnFace').disabled=true;
  document.getElementById('btnFace').textContent='ğŸ“¸ Start Face Scan';
  document.getElementById('btnFace').onclick=captureFace;
  showFacePanel('cam');al('e4','','');startFaceLoop();
  setTimeout(function(){if(document.getElementById('btnFace').disabled)document.getElementById('btnManual').style.display='flex';},18000);
}

function stopFaceCam(){
  clearInterval(faceLoop);
  if(faceStream){faceStream.getTracks().forEach(function(t){t.stop();});faceStream=null;}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STEP 5 â€” Register
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function doRegister(){
  var btn=document.getElementById('btnReg');
  btn.disabled=true;btn.innerHTML='<span class="spin"></span> Registeringâ€¦';
  try{
    var res=await fetch('/api/voter/register',{
      method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({
        name:reg.name,dob:reg.dob,phone:reg.phone,address:reg.address,
        proofType:reg.proofType||proofType,proofVerified:proofOK,
        faceDescriptor:Array.from(finalDesc)
      })
    });
    var data=await res.json();
    if(res.status===409&&data.error==='DUPLICATE_VOTER'){stopFaceCam();goStep(5);showDup(data);return;}
    if(!res.ok) throw new Error(data.error||'Registration failed.');
    stopFaceCam();goStep(5);showDone(data);
  }catch(e){
    document.getElementById('s4c').insertAdjacentHTML('afterbegin','<div class="al err" style="margin-bottom:10px;">âŒ '+e.message+'</div>');
    btn.disabled=false;btn.innerHTML='âœ… Complete Registration';
  }
}

function showDone(data){
  document.getElementById('s5content').innerHTML=
    '<div class="card" style="text-align:center;padding:28px 20px;">'+
    '<div style="font-size:3rem;margin-bottom:12px;">ğŸ‰</div>'+
    '<h2 style="margin-bottom:6px;">Registered Successfully!</h2>'+
    '<p style="color:#64748b;font-size:13px;margin-bottom:20px;">Save your Voter ID â€” you need it to login and vote.</p>'+
    '<div class="vid-card"><div style="font-size:10px;opacity:.6;text-transform:uppercase;letter-spacing:.08em;">ğŸ—³ï¸ Voter ID</div>'+
    '<div class="vid-num">'+data.voterId+'</div>'+
    '<div style="font-weight:700;">'+data.name+'</div>'+
    '<div style="font-size:11px;opacity:.5;margin-top:8px;">ğŸ“¸ Screenshot this now!</div></div>'+
    '<div class="al warn" style="text-align:left;margin:14px 0;font-size:12px;">âš ï¸ <strong>Screenshot your Voter ID now.</strong> It cannot be recovered if lost.</div>'+
    '<a href="/voter-login" class="btn blue" style="max-width:300px;margin:0 auto;display:flex;">Login to Vote â†’</a></div>';
}

function showDup(data){
  var reasons={phone:'This phone number is already registered.',name_dob:'Same name and date of birth already registered.',face:'Our AI detected your face is already registered.'};
  document.getElementById('s5content').innerHTML=
    '<div class="card" style="text-align:center;padding:24px 20px;">'+
    '<div style="width:68px;height:68px;background:#fee2e2;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:2rem;margin:0 auto 14px;">ğŸš«</div>'+
    '<h2 style="color:#b91c1c;margin-bottom:6px;">Already Registered!</h2>'+
    '<p style="color:#64748b;font-size:13px;margin-bottom:14px;">You are an existing voter.</p>'+
    '<div style="background:#fef2f2;border:2px solid #fecaca;border-radius:14px;padding:14px;margin-bottom:14px;text-align:left;">'+
    '<p style="font-size:13px;color:#7f1d1d;margin-bottom:12px;">âš ï¸ '+(reasons[data.type]||data.message)+'</p>'+
    '<div style="display:flex;align-items:center;gap:10px;border-top:1px solid #fecaca;padding-top:12px;">'+
    '<div style="width:40px;height:40px;background:#fee2e2;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1.3rem;flex-shrink:0;">ğŸ§‘â€ğŸ’¼</div>'+
    '<div><div style="font-weight:800;">'+data.existingName+'</div>'+
    '<div style="font-family:monospace;font-size:15px;color:#4f46e5;font-weight:900;">'+data.existingVoterId+'</div></div></div></div>'+
    '<div class="al ok" style="text-align:left;font-size:13px;margin-bottom:14px;">âœ… Use Voter ID <strong style="font-family:monospace;">'+data.existingVoterId+'</strong> to login and vote.</div>'+
    '<a href="/voter-login" class="btn blue" style="display:flex;margin-bottom:8px;">ğŸ—³ï¸ Go to Voter Login</a>'+
    '<a href="/" style="font-size:13px;color:#94a3b8;display:block;margin-top:6px;">â† Home</a></div>';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UTILITIES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function avgDescs(descs){
  var out=new Float32Array(128);
  for(var d=0;d<descs.length;d++) for(var i=0;i<128;i++) out[i]+=descs[d][i];
  for(var i=0;i<128;i++) out[i]/=descs.length;
  return out;
}
function enhanceFrame(vid){
  var c=document.createElement('canvas');c.width=vid.videoWidth||640;c.height=vid.videoHeight||480;
  var ctx=c.getContext('2d');
  var b=faceLux<80?2.0:faceLux<130?1.6:1.3, con=faceLux<80?1.6:1.3;
  ctx.filter='brightness('+b+') contrast('+con+')';ctx.drawImage(vid,0,0);return c;
}
function measureFaceLux(vid){
  try{
    var c=document.createElement('canvas');c.width=80;c.height=60;
    var ctx=c.getContext('2d');ctx.drawImage(vid,0,0,80,60);
    var px=ctx.getImageData(0,0,80,60).data,s=0;
    for(var i=0;i<px.length;i+=16)s+=(px[i]+px[i+1]+px[i+2])/3;
    faceLux=s/(px.length/16);
    var chip=document.getElementById('faceLx');if(!chip)return;
    if(faceLux<50){chip.textContent='ğŸŒ‘ Very Dark';chip.style.background='rgba(120,53,15,.85)';if(!faceBoostOn){faceBoostOn=true;applyFaceFilter();document.getElementById('faceBoost').classList.add('on');}}
    else if(faceLux<90){chip.textContent='ğŸŒ™ Low';chip.style.background='rgba(100,50,0,.85)';}
    else if(faceLux<160){chip.textContent='ğŸ’¡ OK';chip.style.background='rgba(0,0,0,.6)';}
    else{chip.textContent='â˜€ï¸ Good';chip.style.background='rgba(5,80,40,.85)';}
  }catch(e){}
}
function pixelFP(vid){
  var c=document.createElement('canvas');c.width=64;c.height=64;
  c.getContext('2d').drawImage(vid,0,0,64,64);
  var px=c.getContext('2d').getImageData(0,0,64,64).data;
  return Array.from({length:128},function(_,i){var idx=((i/128)*(px.length/4))|0;return(px[idx*4]+px[idx*4+1]+px[idx*4+2])/(255*3);});
}
function loadScript(src){
  return new Promise(function(res,rej){
    var s=document.createElement('script');s.src=src;s.onload=res;s.onerror=rej;document.head.appendChild(s);
  });
}

// â”€â”€ INIT â€” safe, runs after DOM ready â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.addEventListener('DOMContentLoaded', function(){
  try { buildOtp(); } catch(e){ console.error('buildOtp error:', e); }
  goStep(1);
});
// Fallback if DOMContentLoaded already fired
if(document.readyState !== 'loading'){
  try { buildOtp(); } catch(e){ console.error('buildOtp error:', e); }
  goStep(1);
}
</script>
</body>
</html>
